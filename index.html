<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pet Peeves ‚Äì Coco/Ollie</title>
<style>
  :root{
    --bg:#0b1424; --panel:#121f35; --panel2:#0f1b2f;
    --ink:#eaf1ff; --muted:rgba(234,241,255,.78); --muted2:rgba(234,241,255,.60);
    --line:rgba(255,255,255,.08); --blue:#2f6df6; --purple:#8a5cff;
    --good:#5cffad; --bad:#ff6b6b; --caution:#ffd166;
    --shadow:0 16px 44px rgba(0,0,0,.34); --radius:18px; --radius2:14px;
    --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:18px;
    background: radial-gradient(1200px 800px at 20% 0%, rgba(47,109,246,.18), transparent 55%),
                radial-gradient(1200px 800px at 80% 10%, rgba(138,92,255,.14), transparent 55%),
                var(--bg);
    color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .wrap{max-width:980px; margin:0 auto}
  .hero{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    margin:10px 0 14px; padding:14px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border-radius: var(--radius); box-shadow: var(--shadow);
  }
  .hero h1{font-size:18px; margin:0; letter-spacing:.2px;}
  .hero .sub{font-size:13px; color:var(--muted); margin-top:3px;}
  .badgeRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .badge{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--muted); white-space:nowrap;}
  .tabs{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:14px 0 18px;}
  .tabBtn{
    border:none; cursor:pointer; padding:11px 14px; border-radius:999px;
    font-weight:800; color:var(--ink);
    background:rgba(255,255,255,.05); border:1px solid var(--line);
    transition:transform .08s ease, background .2s ease;
  }
  .tabBtn:active{transform:scale(.98)}
  .tabBtn.active{background:linear-gradient(180deg,rgba(47,109,246,.45),rgba(47,109,246,.22)); border-color:rgba(47,109,246,.45);}
  .tabBtn.red-tab.active{background:linear-gradient(180deg,rgba(255,107,107,.45),rgba(255,107,107,.22)); border-color:rgba(255,107,107,.45);}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.045),rgba(255,255,255,.02));
    border:1px solid var(--line); border-radius:var(--radius);
    padding:16px; box-shadow:var(--shadow); margin-bottom:16px;
  }
  .card h2{margin:0 0 10px; font-size:16px; letter-spacing:.2px;}
  .muted{color:var(--muted); font-size:13px; line-height:1.45}
  .muted2{color:var(--muted2); font-size:12px; line-height:1.45}
  .divider{height:1px; background:var(--line); margin:12px 0}
  .grid2{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media(max-width:820px){.grid2{grid-template-columns:1fr}}
  textarea,input,select{
    width:100%; padding:12px; border-radius:14px;
    border:1px solid var(--line); background:rgba(10,18,32,.65);
    color:var(--ink); outline:none; font-size:16px;
  }
  textarea{min-height:122px; resize:vertical}
  label{display:block; font-size:12px; color:var(--muted); font-weight:800; margin:10px 0 6px}
  .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .btn{border:none; cursor:pointer; padding:11px 14px; border-radius:14px; font-weight:900; color:var(--ink); background:rgba(255,255,255,.06); border:1px solid var(--line);}
  .btn.primary{background:linear-gradient(180deg,rgba(47,109,246,.55),rgba(47,109,246,.25)); border-color:rgba(47,109,246,.45);}
  .btn.purple{background:linear-gradient(180deg,rgba(138,92,255,.50),rgba(138,92,255,.22)); border-color:rgba(138,92,255,.40);}
  .btn.danger{background:linear-gradient(180deg,rgba(255,107,107,.24),rgba(255,107,107,.12)); border-color:rgba(255,107,107,.30);}
  .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .pill{display:inline-flex; gap:7px; align-items:center; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--muted);}
  .pill.good{color:var(--good); border-color:rgba(92,255,173,.28); background:rgba(92,255,173,.08)}
  .pill.bad{color:var(--bad); border-color:rgba(255,107,107,.28); background:rgba(255,107,107,.08)}
  .pill.caution{color:var(--caution); border-color:rgba(255,209,102,.28); background:rgba(255,209,102,.08)}
  .tag{font-size:11px; font-weight:950; padding:4px 9px; border-radius:999px; display:inline-block; margin-left:8px; border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--muted);}
  .tag.food{border-color:rgba(47,109,246,.4); background:rgba(47,109,246,.14); color:#cfe0ff}
  .tag.add{border-color:rgba(138,92,255,.4); background:rgba(138,92,255,.14); color:#e3d7ff}
  .tag.toxic{border-color:rgba(255,107,107,.4); background:rgba(255,107,107,.14); color:#ffd0d0}
  .result{margin-top:12px; padding:12px; border-radius:var(--radius2); border:1px solid var(--line); background:rgba(8,14,26,.60);}
  .result .title{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; font-weight:950; letter-spacing:.2px;}
  .result .title .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .result .reason{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.45}
  .result.good{border-color:rgba(92,255,173,.22)}
  .result.bad{border-color:rgba(255,107,107,.22)}
  .result.caution{border-color:rgba(255,209,102,.20)}
  .mono{font-family:var(--mono)}
  details{margin-top:10px; border-radius:var(--radius2); border:1px solid var(--line); background:rgba(8,14,26,.55); padding:10px 12px;}
  summary{cursor:pointer; font-weight:950; color:var(--ink)}
  .mini{font-size:12px; color:var(--muted2); line-height:1.5; margin-top:8px}
  .kicker{font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .savedCard{border:1px solid var(--line); background:rgba(8,14,26,.55); border-radius:var(--radius); padding:12px; margin-top:12px;}
  .savedCard h3{margin:0 0 6px; font-size:14px}
  .savedMeta{font-size:12px; color:var(--muted); margin-bottom:10px}
  .savedBox{border:1px solid var(--line); border-radius:var(--radius2); background:rgba(255,255,255,.03); padding:10px; margin-top:10px;}
  .savedBox .mono{white-space:pre-wrap}
  /* Danger grid */
  .danger-grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); margin-top:12px;}
  .danger-card{border:1px solid rgba(255,107,107,.20); background:rgba(255,107,107,.06); border-radius:var(--radius2); padding:12px;}
  .danger-card h3{margin:0 0 4px; font-size:13px; color:var(--bad);}
  .danger-card .why{font-size:12px; color:var(--muted2); line-height:1.5;}
  .danger-card .sev{display:inline-block; margin-top:6px; font-size:11px; font-weight:900; padding:3px 8px; border-radius:999px;}
  .sev.fatal{background:rgba(255,50,50,.15); color:#ff6b6b; border:1px solid rgba(255,107,107,.3)}
  .sev.serious{background:rgba(255,160,50,.12); color:#ffa040; border:1px solid rgba(255,160,80,.3)}
  .sev.moderate{background:rgba(255,209,102,.10); color:var(--caution); border:1px solid rgba(255,209,102,.28)}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div>
      <h1>üêæ Pet Peeves ‚Äî Coco/Ollie</h1>
      <div class="sub">Food + Additives scanner ‚Ä¢ Universal dog safety ‚Ä¢ Smart keyword matching ‚Ä¢ Meal Planner</div>
    </div>
    <div class="badgeRow">
      <span class="badge">‚úÖ Smart matching</span>
      <span class="badge">‚úÖ Plural-proof</span>
      <span class="badge">‚úÖ Universal safety</span>
      <span class="badge">‚úÖ US units</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" id="tab-scanner" onclick="showTab('scanner')">üîç Scanner</button>
    <button class="tabBtn red-tab" id="tab-safety" onclick="showTab('safety')">üö® Dog Safety</button>
    <button class="tabBtn" id="tab-meal" onclick="showTab('meal')">üç≤ Meal Planner</button>
    <button class="tabBtn" id="tab-saved" onclick="showTab('saved')">üíæ Saved Meals</button>
    <button class="tabBtn" id="tab-lists" onclick="showTab('lists')">üìö Lists</button>
  </div>

  <!-- SCANNER -->
  <div id="scanner" class="card">
    <h2>üîç Scanner</h2>
    <div class="muted">Paste ingredients (comma or line separated). Scans <b>Food + Additives</b> against Coco & Ollie's personal reactivity lists with smart keyword matching.</div>
    <label>Ingredients to scan</label>
    <textarea id="scanInput" placeholder="Example:
Ingredients: apples, calcium ascorbate, calcium carbonate (to maintain freshness)
Chicken, beef, yogurt, carrots, rice flour, coconut oil, E 221 sodium sulphite, green peppers"></textarea>
    <div class="btnRow">
      <button class="btn primary" onclick="runScan()">Scan</button>
      <button class="btn" onclick="demoScan()">Demo</button>
      <button class="btn" onclick="clearScan()">Clear</button>
    </div>
    <div id="scanResults"></div>
    <details>
      <summary>üì∏ Tips</summary>
      <div class="mini">
        <b>iPhone:</b> photo ‚Üí Live Text ‚Üí copy ‚Üí paste here.<br><br>
        <b>Smart matching:</b> <span class="mono">green peppers</span> matches <span class="mono">Pepper - green</span>. Plurals, word order, and dashes handled automatically.
      </div>
    </details>
  </div>

  <!-- UNIVERSAL DOG SAFETY -->
  <div id="safety" class="card" style="display:none">
    <h2>üö® Universal Dog Safety Checker</h2>
    <div class="muted">Check any human food against things that are <b>toxic or dangerous for ALL dogs</b> ‚Äî regardless of breed or individual reactivity. Type foods below to check them instantly, or browse the full danger reference list below.</div>
    <label>Food to check (comma or line separated)</label>
    <textarea id="safetyInput" placeholder="Example: chocolate, grapes, onion, peanut butter, xylitol, garlic, avocado"></textarea>
    <div class="btnRow">
      <button class="btn danger" onclick="runSafetyCheck()">Check Safety</button>
      <button class="btn" onclick="clearSafety()">Clear</button>
    </div>
    <div id="safetyResults"></div>
    <div class="divider"></div>
    <div class="muted" style="font-weight:900; margin-bottom:4px;">‚ö†Ô∏è Full Danger Reference ‚Äî Toxic to ALL Dogs</div>
    <div class="muted2" style="margin-bottom:8px;">These are universal dog toxins. Always keep these away from any dog.</div>
    <div class="danger-grid" id="dangerGrid"></div>
  </div>

  <!-- MEAL PLANNER -->
  <div id="meal" class="card" style="display:none">
    <h2>üç≤ Meal Planner</h2>
    <div class="muted">Generates meals from dog-edible foods, filtered to exclude anything Moderate/High for either dog. US units only.</div>
    <div class="grid2">
      <div><label>Coco weight (lbs)</label><input id="cocoWeight" type="number" value="55" min="1" step="1"/></div>
      <div><label>Ollie weight (lbs)</label><input id="ollieWeight" type="number" value="65" min="1" step="1"/></div>
    </div>
    <div class="grid2">
      <div>
        <label>Activity level</label>
        <select id="activity">
          <option value="sedentary">Sedentary / weight loss</option>
          <option value="normal" selected>Normal</option>
          <option value="active">Active</option>
          <option value="very_active">Very active</option>
          <option value="working">Working / high output</option>
        </select>
        <div class="muted2" id="activityHint"></div>
      </div>
      <div>
        <label>Meals per day</label>
        <select id="mealsPerDay">
          <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
        </select>
      </div>
    </div>
    <label>Batch days (1‚Äì7)</label>
    <input id="batchDays" type="range" min="1" max="7" value="7"/>
    <div class="kicker"><span class="badge" id="batchLabel">7 days</span><span class="muted2">For grocery totals + batch cook math</span></div>
    <div class="grid2">
      <div>
        <label>Liquid display</label>
        <select id="liquidUnit"><option value="fl_oz" selected>fl oz (US)</option><option value="cups">cups</option></select>
      </div>
      <div>
        <label>Flavor intensity</label>
        <select id="flavorIntensity"><option value="light">Light</option><option value="normal" selected>Normal</option><option value="extra">Extra tasty</option></select>
      </div>
    </div>
    <div class="btnRow">
      <button class="btn primary" onclick="generateMeal()">Generate Meal</button>
      <button class="btn purple" onclick="saveMeal()">Save Meal</button>
      <button class="btn" onclick="copyLastGrocery()">Copy Grocery</button>
      <button class="btn" onclick="exportLastGrocery()">Export Grocery</button>
    </div>
    <div id="mealOutput"></div>
    <details>
      <summary>üß† Notes</summary>
      <div class="mini">‚Ä¢ Planning tool only ‚Äî consult your vet for serious symptoms.<br>‚Ä¢ "Safe" = not on Moderate/High lists for either dog.<br>‚Ä¢ Always avoid onion/garlic seasoning. Keep broth plain.</div>
    </details>
  </div>

  <!-- SAVED -->
  <div id="saved" class="card" style="display:none">
    <h2>üíæ Saved Meals</h2>
    <div class="muted">Saved on this device. Each snapshot includes meal, feeding amounts, grocery list, and cooking instructions.</div>
    <div id="savedMeals"></div>
  </div>

  <!-- LISTS -->
  <div id="lists" class="card" style="display:none">
    <h2>üìö Lists</h2>
    <div class="muted">High + Moderate reactivity lists used by the Scanner.</div>
    <details open><summary>üçñ Food ‚Äî Coco</summary><div class="mini" id="listFoodCoco"></div></details>
    <details><summary>üçñ Food ‚Äî Ollie</summary><div class="mini" id="listFoodOllie"></div></details>
    <details><summary>üß™ Additives ‚Äî Coco</summary><div class="mini" id="listAddCoco"></div></details>
    <details><summary>üß™ Additives ‚Äî Ollie</summary><div class="mini" id="listAddOllie"></div></details>
    <details><summary>üß∑ Combined</summary><div class="mini" id="listCombined"></div></details>
  </div>
</div>

<script>
/* ===== DATA ===== */
const DATA={
  food:{
    coco:{
      high:["Canola Oil","Chia Seeds","Clove","Haddock","Herring","Mozzarella","Paprika","Peach","Rabbit","Rabbit Heart","Rabbit Liver","Rapeseed oil","Sugar (brown)","Sweet Potato","Tahini"],
      moderate:["Ammonium Laureth Sulfate","Beef","Bilberry","Cheese - Cheddar","Chlorella","Coconut","Cornflakes","Egg Yolk - Chicken","Egg Yolk - Duck","Hare","Iceberg lettuce","Lemon","Pecan nut","Pepper - green","Psyllium Seed Husk","Strawberry","Turnip","Winkles"]
    },
    ollie:{
      high:["Avocado oil","Boar","Buttermilk","Canola Meal","Coconut","Coconut Oil","Crab","Duck Liver","Noodles - wheat","Papaya","Parmesan","Prawn","Sage","Strawberry","Tapioca","Venison Meal"],
      moderate:["Anchovy","Catfish","Cheese - Cottage","Chicken Heart","Condensed milk","Cream","Egg White - Chicken","Emmer wheat","Farina secalis cerealis","Ginkgo biloba","Greens (Collard)","Lamb Liver","Liver - ox","Milkweed","Onion","Pepper - green","Pheasant Gizzard","Pigeon","Raisin","Skate","Soy Flour","Sweet Potato","Tilefish","Winkles"]
    }
  },
  additives:{
    coco:{
      high:["E 110 Sunset Yellow (orange synthetic dye)","E 160 b Annatto (yellow to orange coloring)","E 180 Lithol Rubine BK (red synthetic dye)","E 221 Sodium sulphite (preservative)","E 332 Potassium citrate (acidity regulator)","E 483 Stearyl tartrate (emulsifier)","E 576 Sodium gluconate (acidity regulator)","E 620 Glutamic acid (flavour enhancer)","E 959 Neohesperidine DC (sweetener)","Rose (Rosa spp.)"],
      moderate:["Artichoke leaf extract","E 200 Sorbic acid (preservative)","E 233 Thiabendazole (preservative/fungicide)","E 312 Dodecyl gallate (antioxidant)","E 340 Potassium phosphate (emulsifier)","E 411 Xantham gum (thickener)","E 528 Magnesium hydroxide (acidity regulator)","E 535 Sodium ferrocyanide (anti-caking agent)","E 624 Monoammonium glutamate (flavour enhancer)","E 629 Calcium guanylate (flavour enhancer)","E 630 Inosinic acid (flavour enhancer)","E 927 Azodicarbonamide (flour treatment agent)","Rosemary Extract"]
    },
    ollie:{
      high:["E 141 Copper complexes of chlorophyll (green coloring)","E 150 d Sulphite Ammonia Caramel (brown coloring)","E 160 e Beta-apo-8'-carotenal (orange pigment)","E 162 Beetroot red (natural red coloring)","E 218 Methyl p-hydroxybenzoate (preservative)","E 242 Dimethyl dicarbonate (sterilizing agent)","E 260 Acetic acid (preservative)","E 263 Calcium acetate (acidity regulator)","E 270 Lactic acid (preservative)","E 335 Sodium tartrate (acidity regulator)","E 472 d Tartaric acid esters of mono- and diglycerides (emulsifier)","E 473 Sucrose esters of fatty acids (emulsifier)","E 477 Propylene glycol esters of fatty acids (emulsifier)","E 522 Aluminium potassium sulphate (stabiliser)","E 541 Sodium aluminium phosphate (raising agent)","E 630 Inosinic acid (flavour enhancer)","E 941 Nitrogen (packing gas)","E 951 Aspartame (sweetener)","Formic acid","Pepsin","Tartaric acid"],
      moderate:["E 150 c Ammonia Caramel (brown coloring)","E 1520 Propylene glycol","E 249 Potassium nitrite (curing agent)","E 284 Boric acid (preservative)","E 312 Dodecyl gallate (antioxidant)","E 334 Tartaric acid (acidity regulator)","E 353 Metatartaric acid (acidity regulator)","E 354 Calcium tartrate (acidity regulator)","E 472 e Mono- and diacetyltartaric acid esters of mono- and diglycerides (emulsifier)","E 476 Polyglycerol polyricinoleate (emulsifier)","E 554 Sodium aluminosilicate (anti-caking agent)","E 621 Monosodium glutamate (flavour enhancer)","E 634 Calcium 5'-ribonucleotides (flavour enhancer)","E 902 Candelilla wax (coating agent)","E 903 Carnauba wax (coating agent)","Formalin"]
    }
  }
};

/* ===== UNIVERSAL DANGER LIST ===== */
const DANGERS=[
  {name:"Chocolate / Cocoa",aliases:["chocolate","cocoa","cacao","dark chocolate","milk chocolate","white chocolate","baking chocolate"],severity:"fatal",why:"Contains theobromine and caffeine ‚Äî dogs metabolize these far slower than humans. Causes vomiting, seizures, heart failure, and can be fatal. Dark and baking chocolate are most dangerous."},
  {name:"Grapes & Raisins",aliases:["grape","grapes","raisin","raisins","currant","currants","sultana","sultanas"],severity:"fatal",why:"Even small amounts can cause sudden kidney failure. The toxic compound is unknown. No safe dose ‚Äî any ingestion is an emergency."},
  {name:"Xylitol",aliases:["xylitol","birch sugar","birch sweetener"],severity:"fatal",why:"Found in sugar-free gum, candy, and some peanut butters. Causes rapid insulin release, hypoglycemia, liver failure, and death. Always check labels."},
  {name:"Onions & Garlic",aliases:["onion","onions","garlic","leek","leeks","chive","chives","shallot","shallots","scallion","scallions"],severity:"serious",why:"All Allium family members destroy red blood cells, causing hemolytic anemia. Cooked, raw, or powdered forms are all toxic. Symptoms may be delayed 3‚Äì5 days."},
  {name:"Macadamia Nuts",aliases:["macadamia","macadamia nut","macadamia nuts"],severity:"serious",why:"Even small amounts cause weakness, vomiting, tremors, and fever. Mechanism unknown. Always toxic ‚Äî no safe amount established."},
  {name:"Alcohol",aliases:["alcohol","beer","wine","liquor","vodka","whiskey","rum","ethanol","spirits","booze"],severity:"fatal",why:"Dogs are far more sensitive than humans. Even small amounts cause disorientation, low blood sugar, seizures, and death."},
  {name:"Caffeine",aliases:["caffeine","coffee","espresso","tea","energy drink","soda","cola"],severity:"serious",why:"Causes restlessness, rapid breathing, heart palpitations, tremors, and seizures. No antidote ‚Äî treatment is supportive care only."},
  {name:"Avocado",aliases:["avocado","avocados","guacamole"],severity:"serious",why:"Contains persin, causing vomiting, diarrhea, and fluid buildup around the heart and lungs. The pit is also a dangerous choking hazard."},
  {name:"Raw Yeast Dough",aliases:["yeast dough","raw dough","bread dough","pizza dough"],severity:"serious",why:"Expands in the stomach causing painful bloating and potentially fatal GDV. Fermenting yeast also produces alcohol which adds a second toxicity risk."},
  {name:"Nutmeg",aliases:["nutmeg"],severity:"serious",why:"Contains myristicin which causes disorientation, increased heart rate, high blood pressure, seizures, and hallucinations."},
  {name:"Apple Seeds / Fruit Pits",aliases:["apple seed","apple seeds","apple core","cherry pit","cherry pits","peach pit","plum pit","apricot pit","fruit seeds","fruit pit"],severity:"serious",why:"Contain cyanogenic glycosides which release cyanide when chewed. Fruit flesh is fine, but always remove pits and seeds."},
  {name:"Raw Salmon / Raw Fish",aliases:["raw salmon","raw fish","raw trout","uncooked salmon","uncooked fish"],severity:"serious",why:"Can carry Neorickettsia helminthoeca causing Salmon Poisoning Disease, which is often fatal if untreated. Always cook fish fully."},
  {name:"Moldy Food",aliases:["mold","mouldy","moldy","rotten food","spoiled food","old food"],severity:"serious",why:"Mold produces mycotoxins that cause tremors, seizures, vomiting, and high temperature. Never allow dogs to eat from the trash."},
  {name:"Salt / Sodium (large amounts)",aliases:["salt","sodium","salty","sea salt","table salt"],severity:"moderate",why:"Large amounts cause sodium ion poisoning ‚Äî vomiting, diarrhea, seizures, and potentially death. Salty snacks like chips are risky."},
  {name:"Cooked Bones",aliases:["cooked bone","cooked bones","chicken bone","chicken bones","rib bone","turkey bone"],severity:"serious",why:"Cooked bones splinter easily and can puncture the digestive tract, causing internal bleeding and dangerous blockages."},
  {name:"Walnuts (Black)",aliases:["black walnut","black walnuts","walnut","walnuts"],severity:"serious",why:"Black walnuts are toxic and cause tremors and seizures. Regular walnuts can grow mold (juglone) that causes neurological damage."},
  {name:"Tobacco / Nicotine",aliases:["tobacco","nicotine","cigarette","cigarettes","vape","nicotine patch"],severity:"fatal",why:"Nicotine is rapidly toxic ‚Äî causes vomiting, seizures, rapid heart rate, collapse, and death. Cigarettes, vapes, and patches are all dangerous."},
  {name:"Raw Potatoes / Green Potatoes",aliases:["raw potato","raw potatoes","green potato","potato plant","potato skin"],severity:"moderate",why:"Contain solanine which is toxic to dogs. Cooked plain potatoes are fine. Never feed raw or green potatoes."},
  {name:"Wild Mushrooms",aliases:["mushroom","mushrooms","wild mushroom","toadstool"],severity:"fatal",why:"Many wild varieties cause liver failure and death. Store-bought button mushrooms are generally safe, but wild mushrooms must always be avoided."},
];

/* ===== MATCHING ENGINE ===== */
function normText(s){
  return (s||"").replace(/\u2019/g,"'").toLowerCase()
    .replace(/\([^)]*\)/g," ").replace(/[^a-z0-9\s\-]/g," ").replace(/\s+/g," ").trim();
}
function singularize(w){
  if(w.endsWith("ies")&&w.length>4) return w.slice(0,-3)+"y";
  if(w.endsWith("ses")&&w.length>4) return w.slice(0,-2);
  if(w.endsWith("s")&&!w.endsWith("ss")&&w.length>3) return w.slice(0,-1);
  return w;
}
function tokenize(s){ return normText(s).replace(/-/g," ").split(/\s+/).filter(Boolean).map(singularize); }
function tokSet(s){ return new Set(tokenize(s)); }
function buildMap(items){ return items.map(c=>({canonical:c,tokens:tokSet(c)})); }

const MAPS={
  food:{
    coco:{high:buildMap(DATA.food.coco.high),moderate:buildMap(DATA.food.coco.moderate)},
    ollie:{high:buildMap(DATA.food.ollie.high),moderate:buildMap(DATA.food.ollie.moderate)}
  },
  additives:{
    coco:{high:buildMap(DATA.additives.coco.high),moderate:buildMap(DATA.additives.coco.moderate)},
    ollie:{high:buildMap(DATA.additives.ollie.high),moderate:buildMap(DATA.additives.ollie.moderate)}
  }
};

const ALIASES={"brown rice":"Rice (brown)","white rice":"Rice (white)","rice flour":"Rice Flour","rice bran":"Rice Bran","yogurt":"Yogurt (plain)","yoghurt":"Yogurt (plain)","green pepper":"Pepper - green","pepper green":"Pepper - green","bell pepper green":"Pepper - green"};

function setsEq(a,b){if(a.size!==b.size)return false;for(const v of a)if(!b.has(v))return false;return true;}
function isSubset(sub,sup){for(const v of sub)if(!sup.has(v))return false;return true;}

function match(inputToks,entry){
  const iSet=new Set(inputToks),cSet=entry.tokens;
  if(setsEq(iSet,cSet))return true;
  if(cSet.size>=2&&isSubset(cSet,iSet))return true;
  if(iSet.size>=2&&isSubset(iSet,cSet))return true;
  return false;
}

function findReactivityHits(rawTerm){
  const toks=tokenize(rawTerm);
  const aliasKey=normText(rawTerm).replace(/-/g," ").replace(/\s+/g," ").trim();
  const aliasTarget=ALIASES[aliasKey];
  const inputs=aliasTarget?[toks,tokenize(aliasTarget)]:[toks];
  const hits=[];
  for(const type of["food","additives"]){
    for(const dog of["coco","ollie"]){
      for(const sev of["high","moderate"]){
        for(const t of inputs){
          for(const entry of MAPS[type][dog][sev]){
            if(match(t,entry)) hits.push({type,dog,sev:sev==="high"?"High":"Moderate",canonical:entry.canonical});
          }
        }
      }
    }
  }
  // E-number fallback
  const em=rawTerm.match(/\bE\s*(\d+)\b/i);
  if(em){
    const en="e"+em[1];
    for(const dog of["coco","ollie"]){
      for(const sev of["high","moderate"]){
        for(const entry of MAPS.additives[dog][sev]){
          if(entry.canonical.toLowerCase().replace(/\s+/g,"").includes(en))
            hits.push({type:"additives",dog,sev:sev==="high"?"High":"Moderate",canonical:entry.canonical});
        }
      }
    }
  }
  const seen=new Set();
  return hits.filter(h=>{const id=`${h.type}|${h.dog}|${h.sev}|${h.canonical}`;if(seen.has(id))return false;seen.add(id);return true;});
}

function findDangerHit(rawTerm){
  const iSet=new Set(tokenize(rawTerm));
  for(const d of DANGERS){
    for(const a of d.aliases){
      const aSet=new Set(tokenize(a));
      if(setsEq(iSet,aSet)||isSubset(aSet,iSet)||isSubset(iSet,aSet)) return d;
    }
  }
  return null;
}

/* ===== PARENT EXPANSION ===== */
const PARENTS={
  rice:["Rice (brown)","Rice (white)","Rice Bran","Rice Flour","Rice milk"],
  yogurt:["Yogurt (plain)"],
  coconut:["Coconut","Coconut Oil"],
  pepper:["Pepper - green","Pepper - red","Pepper - white","Pepper - black"],
  egg:["Egg White - Chicken","Egg Yolk - Chicken","Egg White - Duck","Egg Yolk - Duck"]
};
function shouldExpand(raw){const t=tokenize(raw);return t.length===1&&!!PARENTS[t[0]];}

/* ===== SCANNER ===== */
function parseInput(raw){
  return (raw||"").replace(/\r/g,"").replace(/ingredients\s*:\s*/ig,"")
    .split(/[\n,;]+/).map(x=>x.trim()).filter(Boolean);
}

function worstSev(hits){
  if(!hits||!hits.length)return null;
  return hits.some(h=>h.sev==="High")?"High":"Moderate";
}

function renderScanResult(item){
  if(shouldExpand(item)) return renderParentCaution(item);
  const typeTag=/\be\s*\d+\b/.test(normText(item))?"additives":"food";
  const hits=findReactivityHits(item);
  if(!hits.length){
    return `<div class="result good"><div class="title"><div class="left">‚úÖ <span>${esc(item)}</span><span class="tag ${typeTag==="food"?"food":"add"}">${typeTag==="food"?"Food":"Additive"}</span></div><span class="pill good">SAFE</span></div><div class="reason">No listed Moderate/High reactivity for Coco or Ollie.</div><div class="pillRow"><span class="pill good">Coco: OK</span><span class="pill good">Ollie: OK</span></div></div>`;
  }
  const bC=hits.filter(h=>h.dog==="coco"),bO=hits.filter(h=>h.dog==="ollie");
  const cW=worstSev(bC),oW=worstSev(bO);
  const why=hits.slice(0,4).map(h=>`${h.type==="food"?"Food":"Additive"}: "${h.canonical}" ‚Üí ${h.dog==="coco"?"Coco":"Ollie"} (${h.sev})`).join(" ¬∑ ");
  const cPill=cW?`<span class="pill ${cW==="High"?"bad":"caution"}">Coco: ${cW}</span>`:`<span class="pill good">Coco: OK</span>`;
  const oPill=oW?`<span class="pill ${oW==="High"?"bad":"caution"}">Ollie: ${oW}</span>`:`<span class="pill good">Ollie: OK</span>`;
  return `<div class="result bad"><div class="title"><div class="left">‚ö†Ô∏è <span>${esc(item)}</span><span class="tag ${typeTag==="food"?"food":"add"}">${typeTag==="food"?"Food":"Additive"}</span></div><span class="pill bad">NOT SAFE</span></div><div class="reason">${esc(why)}</div><div class="pillRow">${cPill}${oPill}</div></div>`;
}

function renderParentCaution(raw){
  const pKey=tokenize(raw)[0]||raw;
  const variants=PARENTS[pKey]||[];
  let rows="",anyFlag=false;
  for(const v of variants){
    const hits=findReactivityHits(v);
    const cW=worstSev(hits.filter(h=>h.dog==="coco"&&h.type==="food"));
    const oW=worstSev(hits.filter(h=>h.dog==="ollie"&&h.type==="food"));
    if(cW||oW)anyFlag=true;
    rows+=`<div class="muted" style="margin-top:8px;line-height:1.4"><b>${esc(v)}</b> ‚Äî <span style="color:${cW==="High"?"var(--bad)":cW==="Moderate"?"var(--caution)":"var(--good)"}">Coco: ${cW||"OK"}</span> ¬∑ <span style="color:${oW==="High"?"var(--bad)":oW==="Moderate"?"var(--caution)":"var(--good)"}">Ollie: ${oW||"OK"}</span></div>`;
  }
  return `<div class="result caution"><div class="title"><div class="left">üü° <span>${esc(raw)}</span><span class="tag food">Food</span></div><span class="pill caution">CAUTION</span></div><div class="reason">${esc(`Generic keyword "${pKey}" ‚Äî showing all known variants.`)}</div><div class="pillRow"><span class="pill caution">Keyword: ${esc(pKey)}</span>${anyFlag?`<span class="pill caution">Some variants flagged</span>`:`<span class="pill good">No variants flagged</span>`}</div><div class="divider"></div>${rows||`<div class="muted2">No variants configured.</div>`}</div>`;
}

function runScan(){
  const items=parseInput(document.getElementById("scanInput").value);
  if(!items.length){document.getElementById("scanResults").innerHTML=`<div class="result"><div class="muted">Paste ingredients first.</div></div>`;return;}
  document.getElementById("scanResults").innerHTML=items.map(renderScanResult).join("");
}
function demoScan(){
  document.getElementById("scanInput").value=`Ingredients: apples, calcium ascorbate, calcium carbonate (to maintain freshness)\nChicken, beef, yogurt, carrots, rice flour, coconut oil, E 221 sodium sulphite, green peppers, collard greens`;
  runScan();
}
function clearScan(){document.getElementById("scanInput").value="";document.getElementById("scanResults").innerHTML="";}

/* ===== SAFETY CHECKER ===== */
function runSafetyCheck(){
  const items=parseInput(document.getElementById("safetyInput").value);
  if(!items.length){document.getElementById("safetyResults").innerHTML=`<div class="result"><div class="muted">Enter some foods to check first.</div></div>`;return;}
  let html="";
  for(const item of items){
    const d=findDangerHit(item);
    if(d){
      const sevLabel=d.severity==="fatal"?"‚ö†Ô∏è POTENTIALLY FATAL":d.severity==="serious"?"üî∂ SERIOUS RISK":"üü° MODERATE RISK";
      html+=`<div class="result bad"><div class="title"><div class="left">üö´ <span>${esc(item)}</span><span class="tag toxic">Toxic</span></div><span class="pill bad">${sevLabel}</span></div><div class="reason"><b>${esc(d.name)}</b> ‚Äî ${esc(d.why)}</div></div>`;
    }else{
      html+=`<div class="result good"><div class="title"><div class="left">‚úÖ <span>${esc(item)}</span></div><span class="pill good">NOT ON DANGER LIST</span></div><div class="reason">Not found in universal dog danger list. Also check in the üîç Scanner tab for Coco & Ollie's personal reactivity.</div></div>`;
    }
  }
  document.getElementById("safetyResults").innerHTML=html;
}
function clearSafety(){document.getElementById("safetyInput").value="";document.getElementById("safetyResults").innerHTML="";}

function renderDangerGrid(){
  const seen=new Set();
  let html="";
  for(const d of DANGERS){
    if(seen.has(d.name))continue; seen.add(d.name);
    const sc=d.severity==="fatal"?"fatal":d.severity==="serious"?"serious":"moderate";
    const sl=d.severity==="fatal"?"‚ö†Ô∏è Potentially Fatal":d.severity==="serious"?"üî∂ Serious Risk":"üü° Moderate Risk";
    html+=`<div class="danger-card"><h3>${esc(d.name)}</h3><div class="why">${esc(d.why)}</div><span class="sev ${sc}">${sl}</span></div>`;
  }
  document.getElementById("dangerGrid").innerHTML=html;
}

/* ===== MEAL PLANNER ===== */
const APCT={sedentary:2.0,normal:2.5,active:3.0,very_active:3.5,working:4.0};
function updateHint(){document.getElementById("activityHint").innerText=`~${(APCT[document.getElementById("activity").value]||2.5).toFixed(1)}% of bodyweight/day`;}
updateHint();
document.getElementById("activity").addEventListener("change",updateHint);
document.getElementById("batchDays").addEventListener("input",()=>{document.getElementById("batchLabel").innerText=`${document.getElementById("batchDays").value} days`;});

function fmtLbsOz(oz){const l=Math.floor(oz/16),r=oz-l*16,rt=+(Math.round(r*10)/10).toFixed(1).replace(/\.0$/,"");return l<=0?`${rt} oz`:`${l} lb ${rt} oz`;}
function fmtCups(oz){return `${+(Math.round(oz/4*100)/100).toFixed(2).replace(/0+$/,"").replace(/\.$/,"")} cups`;}

const LIB={
  proteins:["Chicken","Turkey","Duck","Lamb","Bison","Venison","Beef","Goat","Sardine","Tuna","Cod","Trout","Salmon"],
  carbs:["Rice (brown)","Rice (white)","Quinoa","Oats","Barley","Pumpkin","Butternut squash","Potato","Sweet Potato"],
  veg:["Zucchini","Green beans","Spinach","Broccoli","Peas","Cucumber","Carrot","Cauliflower","Celery","Kale"],
  fats:["Fish Oil","Salmon Oil","Sunflower Oil","Olive Oil","Coconut Oil","Beef Fat"],
  flavor:["Pumpkin puree","Bone broth","Apple","Blueberries","Parsley","Turmeric","Ginger","Honey"]
};
function banned(n){return findReactivityHits(n).filter(h=>h.type==="food").length>0;}
function safePool(arr){return arr.filter(x=>!banned(x));}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}

let LAST_MEAL=null;

function generateMeal(){
  const cLbs=parseFloat(document.getElementById("cocoWeight").value||0);
  const oLbs=parseFloat(document.getElementById("ollieWeight").value||0);
  const mpd=parseInt(document.getElementById("mealsPerDay").value||2,10);
  const days=parseInt(document.getElementById("batchDays").value||7,10);
  const act=document.getElementById("activity").value;
  const fi=document.getElementById("flavorIntensity").value;
  if(!cLbs||!oLbs){document.getElementById("mealOutput").innerHTML=`<div class="result bad"><div class="muted">Enter both weights.</div></div>`;return;}
  const pct=(APCT[act]||2.5)/100;
  const cDOz=cLbs*16*pct,oDOz=oLbs*16*pct,bOz=(cDOz+oDOz)*days;
  const proteins=safePool(LIB.proteins),carbs=safePool(LIB.carbs),veg=safePool(LIB.veg),fats=safePool(LIB.fats),flavors=safePool(LIB.flavor);
  if(!proteins.length||!carbs.length||!veg.length){document.getElementById("mealOutput").innerHTML=`<div class="result bad"><div class="muted">No safe options after filtering. Use the Scanner to pick items manually.</div></div>`;return;}
  const protein=pick(proteins),carb=pick(carbs),veggie=pick(veg),fat=fats.length?pick(fats):"Fish Oil";
  const f1=flavors.length?pick(flavors):"Bone broth";
  let f2=null;
  if(fi==="extra"&&flavors.length>1){for(let i=0;i<8;i++){const c=pick(flavors);if(c!==f1){f2=c;break;}}}
  const g={protein:bOz*0.50,carb:bOz*0.20,veg:bOz*0.15,fat:bOz*0.05,boost:bOz*0.10};
  const bA=f2?g.boost*0.6:g.boost,bB=f2?g.boost*0.4:0;
  const cMOz=cDOz/mpd,oMOz=oDOz/mpd;
  const gt=buildGrocery({days,mpd,act,cDOz,oDOz,cMOz,oMOz,bOz,protein,carb,veggie,fat,f1,f2,g,bA,bB});
  const ins=buildInstructions({protein,carb,veggie,fat,f1,f2,days});
  LAST_MEAL={id:cryptoId(),createdAt:new Date().toISOString(),meta:{days,mpd,act,pct:APCT[act]||2.5},weights:{cLbs,oLbs},feeding:{cDOz,oDOz,cMOz,oMOz,bOz},picks:{protein,carb,veggie,fat,f1,f2},g,bA,bB,groceryText:gt,instructions:ins};
  document.getElementById("mealOutput").innerHTML=`
    <div class="divider"></div>
    <div class="result good">
      <div class="title"><div class="left">‚ú® Meal Suggestion</div><span class="pill good">SAFE-ONLY FILTER</span></div>
      <div class="reason">Filtered to exclude anything Moderate/High for either dog.</div>
      <div class="pillRow">
        <span class="pill good">Protein: ${esc(protein)}</span><span class="pill good">Carb: ${esc(carb)}</span>
        <span class="pill good">Veg: ${esc(veggie)}</span><span class="pill good">Fat: ${esc(fat)}</span>
        <span class="pill good">Flavor: ${esc(f1)}${f2?` + ${esc(f2)}`:""}</span>
      </div>
      <div class="divider"></div>
      <div class="kicker">
        <span class="badge">Activity: ${esc(actLabel(act))}</span>
        <span class="badge">Rule: ${(APCT[act]||2.5).toFixed(1)}% bodyweight/day</span>
        <span class="badge">Meals/day: ${mpd}</span>
        <span class="badge">Batch: ${days} day(s)</span>
      </div>
      <div class="divider"></div>
      <div class="muted"><b>Feeding amounts</b></div>
      <div class="muted2">
        Coco daily: <b>${fmtLbsOz(cDOz)}</b> (~${fmtCups(cDOz)}) ¬∑ per meal: <b>${fmtLbsOz(cMOz)}</b><br>
        Ollie daily: <b>${fmtLbsOz(oDOz)}</b> (~${fmtCups(oDOz)}) ¬∑ per meal: <b>${fmtLbsOz(oMOz)}</b><br>
        Batch total: <b>${fmtLbsOz(bOz)}</b>
      </div>
      <div class="divider"></div>
      <div class="muted"><b>Grocery breakdown</b></div>
      <div class="savedBox"><div class="muted2 mono">${esc(gt)}</div></div>
      <div class="divider"></div>
      <div class="muted"><b>Cooking instructions</b></div>
      <div class="savedBox"><div class="muted2 mono">${esc(ins)}</div></div>
    </div>`;
}

function buildGrocery(d){
  return [`BATCH GROCERY LIST ‚Äî ${d.days} day(s)`,`Activity: ${actLabel(d.act)}`,`Meals/day: ${d.mpd}`,``,
    `MEAL PICKS`,`- Protein: ${d.protein}`,`- Carb: ${d.carb}`,`- Veg: ${d.veggie}`,`- Fat: ${d.fat}`,`- Flavor: ${d.f1}${d.f2?` + ${d.f2}`:""}`,``,
    `TOTALS`,`- ${d.protein}: ${fmtLbsOz(d.g.protein)}`,`- ${d.carb}: ${fmtLbsOz(d.g.carb)}`,`- ${d.veggie}: ${fmtLbsOz(d.g.veg)}`,`- ${d.fat}: ${fmtLbsOz(d.g.fat)}`,`- ${d.f1}: ${fmtLbsOz(d.bA)}`,
    ...(d.f2?[`- ${d.f2}: ${fmtLbsOz(d.bB)}`]:[]),``,
    `FEEDING`,`- Coco daily: ${fmtLbsOz(d.cDOz)} (~${fmtCups(d.cDOz)})`,`- Coco per meal: ${fmtLbsOz(d.cMOz)}`,
    `- Ollie daily: ${fmtLbsOz(d.oDOz)} (~${fmtCups(d.oDOz)})`,`- Ollie per meal: ${fmtLbsOz(d.oMOz)}`].join("\n");
}
function buildInstructions(d){
  return [`COOKING INSTRUCTIONS (${d.days} day batch)`,``,
    `1) PROTEIN ‚Äî ${d.protein}`,`   ‚Ä¢ Cook fully, no seasoning. Drain fat.`,``,
    `2) CARB ‚Äî ${d.carb}`,`   ‚Ä¢ Cook in water. No salt or onion/garlic.`,``,
    `3) VEG ‚Äî ${d.veggie}`,`   ‚Ä¢ Steam lightly until soft.`,``,
    `4) COMBINE`,`   ‚Ä¢ Cool everything first, then mix.`,`   ‚Ä¢ Add ${d.fat} AFTER cooling.`,``,
    `5) FLAVOR`,`   ‚Ä¢ Stir in ${d.f1}${d.f2?` + ${d.f2}`:""}. Keep plain.`,``,
    `6) STORE`,`   ‚Ä¢ Refrigerate 3‚Äì4 days. Freeze the rest.`].join("\n");
}
function actLabel(k){return({sedentary:"Sedentary",normal:"Normal",active:"Active",very_active:"Very active",working:"Working"})[k]||k;}
function copyLastGrocery(){if(!LAST_MEAL)return alert("Generate a meal first.");copyText(LAST_MEAL.groceryText);}
function exportLastGrocery(){if(!LAST_MEAL)return alert("Generate a meal first.");downloadText(`grocery_${dateStamp()}.txt`,LAST_MEAL.groceryText);}

/* ===== SAVE MEALS ===== */
const LSK="cocoOllie_savedMeals_v1";
function saveMeal(){
  if(!LAST_MEAL){alert("Generate a meal first.");return;}
  const s=loadSaved(); s.unshift(LAST_MEAL);
  try{localStorage.setItem(LSK,JSON.stringify(s));}catch(e){}
  renderSavedMeals(); alert("Saved ‚úÖ");
}
function loadSaved(){try{return JSON.parse(localStorage.getItem(LSK)||"[]")||[];}catch(e){return[];}}
function deleteMeal(id){
  const s=loadSaved().filter(m=>m.id!==id);
  try{localStorage.setItem(LSK,JSON.stringify(s));}catch(e){}
  renderSavedMeals();
}
function renderSavedMeals(){
  const el=document.getElementById("savedMeals"),saved=loadSaved();
  if(!saved.length){el.innerHTML=`<div class="result"><div class="muted">No saved meals yet.</div></div>`;return;}
  el.innerHTML=saved.map(m=>{
    const title=`${m.picks.protein} + ${m.picks.carb} + ${m.picks.veggie}`;
    return `<div class="savedCard">
      <h3>üçΩÔ∏è ${esc(title)}</h3>
      <div class="savedMeta">${new Date(m.createdAt).toLocaleString()} ¬∑ Batch: ${m.meta.days} day(s) ¬∑ Meals/day: ${m.meta.mpd}</div>
      <div class="pillRow">
        <span class="pill good">Protein: ${esc(m.picks.protein)}</span>
        <span class="pill good">Carb: ${esc(m.picks.carb)}</span>
        <span class="pill good">Veg: ${esc(m.picks.veggie)}</span>
        <span class="pill good">Fat: ${esc(m.picks.fat)}</span>
        <span class="pill good">Flavor: ${esc(m.picks.f1)}${m.picks.f2?` + ${esc(m.picks.f2)}`:""}</span>
      </div>
      <div class="savedBox"><div class="muted"><b>Grocery</b></div><div class="muted2 mono">${esc(m.groceryText)}</div>
        <div class="btnRow"><button class="btn" onclick="copyText(${jsonStr(m.groceryText)})">Copy</button><button class="btn" onclick="downloadText('grocery_${escJs(m.id)}.txt',${jsonStr(m.groceryText)})">Export</button></div>
      </div>
      <div class="savedBox"><div class="muted"><b>Cooking</b></div><div class="muted2 mono">${esc(m.instructions)}</div>
        <div class="btnRow"><button class="btn" onclick="copyText(${jsonStr(m.instructions)})">Copy</button></div>
      </div>
      <div class="btnRow"><button class="btn danger" onclick="deleteMeal('${escJs(m.id)}')">Delete</button></div>
    </div>`;
  }).join("");
}

/* ===== LISTS ===== */
function renderLists(){
  document.getElementById("listFoodCoco").innerHTML=`<b>High:</b> ${DATA.food.coco.high.join(", ")}<br><br><b>Moderate:</b> ${DATA.food.coco.moderate.join(", ")}`;
  document.getElementById("listFoodOllie").innerHTML=`<b>High:</b> ${DATA.food.ollie.high.join(", ")}<br><br><b>Moderate:</b> ${DATA.food.ollie.moderate.join(", ")}`;
  document.getElementById("listAddCoco").innerHTML=`<b>High:</b> ${DATA.additives.coco.high.join(", ")}<br><br><b>Moderate:</b> ${DATA.additives.coco.moderate.join(", ")}`;
  document.getElementById("listAddOllie").innerHTML=`<b>High:</b> ${DATA.additives.ollie.high.join(", ")}<br><br><b>Moderate:</b> ${DATA.additives.ollie.moderate.join(", ")}`;
  const cF=[...new Set([...DATA.food.coco.high,...DATA.food.coco.moderate,...DATA.food.ollie.high,...DATA.food.ollie.moderate])].sort((a,b)=>a.localeCompare(b));
  const cA=[...new Set([...DATA.additives.coco.high,...DATA.additives.coco.moderate,...DATA.additives.ollie.high,...DATA.additives.ollie.moderate])].sort((a,b)=>a.localeCompare(b));
  document.getElementById("listCombined").innerHTML=`<b>Food:</b><br>${cF.join(", ")}<br><br><b>Additives:</b><br>${cA.join(", ")}`;
}

/* ===== TABS + UTILS ===== */
function showTab(tab){
  for(const t of["scanner","safety","meal","saved","lists"]){
    document.getElementById(t).style.display=(t===tab)?"block":"none";
    document.getElementById("tab-"+t).classList.toggle("active",t===tab);
  }
  if(tab==="saved")renderSavedMeals();
  if(tab==="lists")renderLists();
  if(tab==="safety")renderDangerGrid();
}
function esc(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");}
function escJs(s){return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");}
function jsonStr(s){return JSON.stringify(String(s));}
function copyText(t){if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(String(t)).then(()=>alert("Copied ‚úÖ")).catch(()=>fbCopy(t));}else fbCopy(t);}
function fbCopy(t){const a=document.createElement("textarea");a.value=String(t);document.body.appendChild(a);a.select();document.execCommand("copy");document.body.removeChild(a);alert("Copied ‚úÖ");}
function downloadText(fn,t){const b=new Blob([String(t)],{type:"text/plain;charset=utf-8"}),u=URL.createObjectURL(b),a=document.createElement("a");a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
function dateStamp(){const d=new Date();return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;}
function cryptoId(){return "m_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);}

renderSavedMeals();
</script>
</body>
</html>
