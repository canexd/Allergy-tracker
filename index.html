<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pet Peeves ‚Äî Ollie & Coco</title>

<style>
:root{
  --bg:#0b1424;
  --panel:#121f35;
  --panel2:#0f1b2f;
  --ink:#eaf1ff;
  --muted:rgba(234,241,255,.78);
  --muted2:rgba(234,241,255,.60);
  --line:rgba(255,255,255,.08);

  --blue:#2f6df6;
  --purple:#8a5cff;

  --good:#5cffad;
  --bad:#ff6b6b;
  --caution:#ffd166;

  --shadow:0 16px 44px rgba(0,0,0,.34);
  --radius:18px;
  --radius2:14px;
  --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
}

*{box-sizing:border-box}
body{
  margin:0; padding:18px;
  background: radial-gradient(1200px 800px at 20% 0%, rgba(47,109,246,.18), transparent 55%),
              radial-gradient(1200px 800px at 80% 10%, rgba(138,92,255,.14), transparent 55%),
              var(--bg);
  color:var(--ink);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.wrap{max-width:980px; margin:0 auto}

.hero{
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  margin:10px 0 14px;
  padding:14px;
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.hero h1{font-size:18px; margin:0}
.hero .sub{font-size:13px; color:var(--muted)}

.badgeRow{display:flex; gap:8px; flex-wrap:wrap}
.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--muted);
}

.tabs{
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:center;
  margin:14px 0 18px;
}

.tabBtn{
  border:none;
  cursor:pointer;
  padding:11px 14px;
  border-radius:999px;
  font-weight:800;
  color:var(--ink);
  background: rgba(255,255,255,.05);
  border:1px solid var(--line);
}
.tabBtn.active{
  background: linear-gradient(180deg, rgba(47,109,246,.45), rgba(47,109,246,.22));
  border-color: rgba(47,109,246,.45);
}

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
  border:1px solid var(--line);
  border-radius: var(--radius);
  padding:16px;
  box-shadow: var(--shadow);
  margin-bottom:16px;
}

textarea,input,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(10,18,32,.65);
  color:var(--ink);
  font-size:16px;
}
textarea{min-height:120px}

.btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.btn{
  border:none; cursor:pointer;
  padding:11px 14px;
  border-radius:14px;
  font-weight:900;
  color:var(--ink);
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
}
.btn.primary{
  background: linear-gradient(180deg, rgba(47,109,246,.55), rgba(47,109,246,.25));
}
.btn.purple{
  background: linear-gradient(180deg, rgba(138,92,255,.50), rgba(138,92,255,.22));
}

.result{
  margin-top:12px;
  padding:12px;
  border-radius: var(--radius2);
  border:1px solid var(--line);
  background: rgba(8,14,26,.60);
}
.result.good{border-color: rgba(92,255,173,.22)}
.result.bad{border-color: rgba(255,107,107,.22)}
.result.caution{border-color: rgba(255,209,102,.22)}

.pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.pill{
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
}
.pill.good{color:var(--good)}
.pill.bad{color:var(--bad)}
.pill.caution{color:var(--caution)}

.tag{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  margin-left:8px;
  border:1px solid var(--line);
}
.tag.food{color:#cfe0ff}
.tag.add{color:#e3d7ff}

.savedCard{
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px;
  margin-top:12px;
}

.savedBox{
  border:1px solid var(--line);
  border-radius:var(--radius2);
  padding:10px;
  margin-top:10px;
}

.mono{font-family:var(--mono); white-space:pre-wrap}
</style>
</head>

<body>
<div class="wrap">

<div class="hero">
  <div>
    <h1>üêæ Pet Peeves ‚Äî Ollie & Coco</h1>
    <div class="sub">Food + Additives ‚Ä¢ Smart Scan ‚Ä¢ Meal Planner ‚Ä¢ Saved Meals</div>
  </div>
  <div class="badgeRow">
    <span class="badge">Smart plurals</span>
    <span class="badge">OCR safe</span>
    <span class="badge">Variant caution</span>
    <span class="badge">US units</span>
  </div>
</div>

<div class="tabs">
  <button class="tabBtn active" id="tab-scanner" onclick="showTab('scanner')">Scanner</button>
  <button class="tabBtn" id="tab-meal" onclick="showTab('meal')">Meal Planner</button>
  <button class="tabBtn" id="tab-saved" onclick="showTab('saved')">Saved Meals</button>
  <button class="tabBtn" id="tab-lists" onclick="showTab('lists')">Lists</button>
</div>

<div id="scanner" class="card">
  <h2>üîç Scanner</h2>
  <textarea id="scanInput" placeholder="Paste ingredients here..."></textarea>
  <div class="btnRow">
    <button class="btn primary" onclick="scanAll()">Scan</button>
    <button class="btn" onclick="demoScan()">Demo</button>
    <button class="btn" onclick="clearScan()">Clear</button>
  </div>
  <div id="scanResults"></div>
</div>

<div id="meal" class="card" style="display:none">
  <h2>üç≤ Meal Planner</h2>
  <div id="mealOutput"></div>
</div>

<div id="saved" class="card" style="display:none">
  <h2>üíæ Saved Meals</h2>
  <div id="savedMeals"></div>
</div>

<div id="lists" class="card" style="display:none">
  <h2>üìö Lists</h2>
  <div id="listCombined"></div>
</div>

</div>

<script>
  /* =========================================================
   DATA ‚Äî COCO & OLLIE (FOOD + ADDITIVES)
========================================================= */

const DATA = {
  food:{
    coco:{
      high:[
        "Canola Oil","Chia Seeds","Clove","Haddock","Herring","Mozzarella","Paprika","Peach",
        "Rabbit","Rabbit Heart","Rabbit Liver","Rapeseed oil","Sugar (brown)","Sweet Potato","Tahini"
      ],
      moderate:[
        "Ammonium Laureth Sulfate","Beef","Bilberry","Cheese - Cheddar","Chlorella","Coconut","Cornflakes",
        "Egg Yolk - Chicken","Egg Yolk - Duck","Hare","Iceberg lettuce","Lemon","Pecan nut","Pepper - green",
        "Psyllium Seed Husk","Strawberry","Turnip","Winkles"
      ]
    },
    ollie:{
      high:[
        "Avocado oil","Boar","Buttermilk","Canola Meal","Coconut","Coconut Oil","Crab","Duck Liver",
        "Noodles - wheat","Papaya","Parmesan","Prawn","Sage","Strawberry","Tapioca","Venison Meal"
      ],
      moderate:[
        "Anchovy","Catfish","Cheese - Cottage","Chicken Heart","Condensed milk","Cream","Egg White - Chicken",
        "Emmer wheat","Farina secalis cerealis","Ginkgo biloba","Greens (Collard)","Lamb Liver","Liver - ox",
        "Milkweed","Onion","Pepper - green","Pheasant Gizzard","Pigeon","Raisin","Skate","Soy Flour",
        "Sweet Potato","Tilefish","Winkles"
      ]
    }
  },

  additives:{
    coco:{
      high:[
        "E 110 Sunset Yellow (orange synthetic dye)",
        "E 160 b Annatto (yellow to orange coloring)",
        "E 180 Lithol Rubine BK (red synthetic dye)",
        "E 221 Sodium sulphite (preservative)",
        "E 332 Potassium citrate (acidity regulator)",
        "E 483 Stearyl tartrate (emulsifier)",
        "E 576 Sodium gluconate (acidity regulator)",
        "E 620 Glutamic acid (flavour enhancer)",
        "E 959 Neohesperidine DC (sweetener)",
        "Rose (Rosa spp.)"
      ],
      moderate:[
        "Artichoke leaf extract",
        "E 200 Sorbic acid (preservative)",
        "E 233 Thiabendazole (preservative/fungicide)",
        "E 312 Dodecyl gallate (antioxidant)",
        "E 340 Potassium phosphate (emulsifier)",
        "E 411 Xantham gum (thickener)",
        "E 528 Magnesium hydroxide (acidity regulator)",
        "E 535 Sodium ferrocyanide (anti-caking agent)",
        "E 624 Monoammonium glutamate (flavour enhancer)",
        "E 629 Calcium guanylate (flavour enhancer)",
        "E 630 Inosinic acid (flavour enhancer)",
        "E 927 Azodicarbonamide (flour treatment agent)",
        "Rosemary Extract"
      ]
    },
    ollie:{
      high:[
        "E 141 Copper complexes of chlorophyll (green coloring)",
        "E 150 d Sulphite Ammonia Caramel (brown coloring)",
        "E 160 e Beta-apo-8'-carotenal (orange pigment)",
        "E 162 Beetroot red (natural red coloring)",
        "E 218 Methyl p-hydroxybenzoate (preservative)",
        "E 242 Dimethyl dicarbonate (sterilizing agent)",
        "E 260 Acetic acid (preservative)",
        "E 263 Calcium acetate (acidity regulator)",
        "E 270 Lactic acid (preservative)",
        "E 335 Sodium tartrate (acidity regulator)",
        "E 472 d Tartaric acid esters of mono- and diglycerides (emulsifier)",
        "E 473 Sucrose esters of fatty acids (emulsifier)",
        "E 477 Propylene glycol esters of fatty acids (emulsifier)",
        "E 522 Aluminium potassium sulphate (stabiliser)",
        "E 541 Sodium aluminium phosphate (raising agent)",
        "E 630 Inosinic acid (flavour enhancer)",
        "E 941 Nitrogen (packing gas)",
        "E 951 Aspartame (sweetener)",
        "Formic acid","Pepsin","Tartaric acid"
      ],
      moderate:[
        "E 150 c Ammonia Caramel (brown coloring)",
        "E 1520 Propylene glycol",
        "E 249 Potassium nitrite (curing agent)",
        "E 284 Boric acid (preservative)",
        "E 312 Dodecyl gallate (antioxidant)",
        "E 334 Tartaric acid (acidity regulator)",
        "E 353 Metatartaric acid (acidity regulator)",
        "E 354 Calcium tartrate (acidity regulator)",
        "E 472 e Mono- and diacetyltartaric acid esters of mono- and diglycerides (emulsifier)",
        "E 476 Polyglycerol polyricinoleate (emulsifier)",
        "E 554 Sodium aluminosilicate (anti-caking agent)",
        "E 621 Monosodium glutamate (flavour enhancer)",
        "E 634 Calcium 5'-ribonucleotides (flavour enhancer)",
        "E 902 Candelilla wax (coating agent)",
        "E 903 Carnauba wax (coating agent)",
        "Formalin"
      ]
    }
  }
};


/* =========================================================
   ULTRA MATCH ENGINE
========================================================= */

// Normalize text (OCR-safe)
function norm(str){
  return (str||"")
    .replace(/\u2019/g,"'")
    .toLowerCase()
    .replace(/ingredients\s*:\s*/ig,"")
    .replace(/\([^)]*\)/g,"")        // remove parenthesis notes
    .replace(/[^a-z0-9\s\-]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

// singularize words
function singular(w){
  if(w.endsWith("ies")) return w.slice(0,-3)+"y";
  if(w.endsWith("s") && !w.endsWith("ss")) return w.slice(0,-1);
  return w;
}

function keyify(str){
  return norm(str)
    .replace(/\-/g," ")
    .split(" ")
    .filter(Boolean)
    .map(singular)
    .join(" ");
}

function tokens(str){
  return keyify(str).split(" ");
}

// order-insensitive phrase containment
function containsAllWords(hay, needle){
  const h = tokens(hay);
  const n = tokens(needle);
  return n.every(word => h.includes(word));
}

// Build lookup maps
function buildLookup(list){
  const map = new Map();
  list.forEach(item => map.set(keyify(item), item));
  return map;
}

const LOOK = {
  food:{
    coco:{
      high: buildLookup(DATA.food.coco.high),
      moderate: buildLookup(DATA.food.coco.moderate)
    },
    ollie:{
      high: buildLookup(DATA.food.ollie.high),
      moderate: buildLookup(DATA.food.ollie.moderate)
    }
  },
  additives:{
    coco:{
      high: buildLookup(DATA.additives.coco.high),
      moderate: buildLookup(DATA.additives.coco.moderate)
    },
    ollie:{
      high: buildLookup(DATA.additives.ollie.high),
      moderate: buildLookup(DATA.additives.ollie.moderate)
    }
  }
};

// Parent keyword groups
const PARENTS = {
  rice:["Rice (brown)","Rice (white)","Rice Flour","Rice Bran","Rice milk"],
  yogurt:["Yogurt (plain)"],
  pepper:["Pepper - green","Pepper - red","Pepper - white","Pepper - black"],
  egg:["Egg Yolk - Chicken","Egg White - Chicken","Egg Yolk - Duck","Egg White - Duck"]
};


// Main match finder
function findReactivityHits(input){

  const hits=[];
  const inputKey = keyify(input);

  ["food","additives"].forEach(type=>{
    ["coco","ollie"].forEach(dog=>{
      ["high","moderate"].forEach(level=>{
        LOOK[type][dog][level].forEach((canonical, key)=>{
          if(containsAllWords(inputKey, key)){
            hits.push({
              type,
              dog,
              severity: level==="high"?"High":"Moderate",
              canonical
            });
          }
        });
      });
    });
  });

  return hits;
}
  /* =========================================================
   SCANNER RENDER ENGINE ‚Äî FINAL
========================================================= */

function parseInput(raw){
  return (raw||"")
    .replace(/\r/g,"")
    .replace(/ingredients\s*:/ig,"")
    .split(/[\n,;]+/)
    .map(x=>x.trim())
    .filter(Boolean);
}

function classifyType(rawTerm){
  const t = norm(rawTerm);
  if(/\be\s*\d+\b/.test(t) || t.startsWith("e ")) return "additives";
  return "food";
}

function renderScanResult(item){

  if(shouldExpandParent(item)){
    return renderParentCaution(item);
  }

  const typeTag = classifyType(item);
  const hits = findReactivityHits(item);

  const inputKey = keyify(item);

  const parentContained = Object.keys(PARENTS).find(p=>{
    if(p==="rice" && isSpecificRice(inputKey)) return false;
    return containsWholePhrase(inputKey, p);
  });

  if(hits.length===0 && parentContained){
    return renderParentCaution(parentContained,{
      displayAs:item,
      reasonOverride:`Contains keyword "${parentContained}". Showing variant breakdown.`
    });
  }

  if(hits.length===0){
    return `
      <div class="result good">
        <div class="title">
          <div class="left">
            ‚úÖ <span>${esc(item)}</span>
            <span class="tag ${typeTag==="food"?"food":"add"}">${typeTag==="food"?"Food":"Additive"}</span>
          </div>
          <span class="pill good">SAFE</span>
        </div>
        <div class="reason">
          No Moderate or High reactivity found for either dog.
        </div>
        <div class="pillRow">
          <span class="pill good">Coco: OK</span>
          <span class="pill good">Ollie: OK</span>
        </div>
      </div>
    `;
  }

  const byDog = {coco:[], ollie:[]};
  hits.forEach(h=>byDog[h.dog].push(h));

  const cocoWorst = worstSeverity(byDog.coco);
  const ollieWorst = worstSeverity(byDog.ollie);

  return `
    <div class="result bad">
      <div class="title">
        <div class="left">
          ‚ö†Ô∏è <span>${esc(item)}</span>
          <span class="tag ${typeTag==="food"?"food":"add"}">${typeTag==="food"?"Food":"Additive"}</span>
        </div>
        <span class="pill bad">NOT SAFE</span>
      </div>
      <div class="reason">${buildWhyText(item,hits)}</div>
      <div class="pillRow">
        ${renderDogPill("Coco", cocoWorst, byDog.coco)}
        ${renderDogPill("Ollie", ollieWorst, byDog.ollie)}
      </div>
    </div>
  `;
}

/* =========================================================
   SCANNER UI
========================================================= */

function scanAll(){
  const items = parseInput(document.getElementById("scanInput").value);
  if(!items.length){
    document.getElementById("scanResults").innerHTML =
      `<div class="result"><div class="muted">Paste ingredients first.</div></div>`;
    return;
  }
  document.getElementById("scanResults").innerHTML =
    items.map(renderScanResult).join("");
}

function demoScan(){
  document.getElementById("scanInput").value =
`Chicken
Green pepper
Carrots
Rice
Rice flour
Yogurt
E 221 Sodium sulphite`;
  scanAll();
}

function clearScan(){
  document.getElementById("scanInput").value="";
  document.getElementById("scanResults").innerHTML="";
}

/* =========================================================
   UTILITIES + TAB LOGIC
========================================================= */

function showTab(tab){
  ["scanner","meal","saved","lists"].forEach(t=>{
    document.getElementById(t).style.display = (t===tab)?"block":"none";
    document.getElementById("tab-"+t).classList.toggle("active",t===tab);
  });
  if(tab==="saved") renderSavedMeals();
  if(tab==="lists") renderLists();
}

function esc(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function copyText(text){
  navigator.clipboard.writeText(text);
}

function downloadText(filename,text){
  const blob=new Blob([text],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  a.click();
  URL.revokeObjectURL(url);
}

function cryptoId(){
  return "m_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);
}

/* =========================================================
   INIT
========================================================= */

renderSavedMeals();
</script>
</body>
</html>
