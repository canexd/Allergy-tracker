<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pet Peeves – Ollie & Coco</title>
  <style>
    :root{
      --bg1:#070f18;
      --bg2:#081a2a;
      --card:#0f2437;
      --card2:#0b1d2e;
      --line:#1b3c5c;
      --text:#e8f0ff;
      --muted:#a9bed7;
      --blue:#2b63ff;
      --green:#39d98a;
      --red:#ff5c5c;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, #0d2a44 0%, transparent 60%),
                  radial-gradient(1000px 800px at 100% 30%, #132b4a 0%, transparent 55%),
                  linear-gradient(160deg,var(--bg2),var(--bg1));
      min-height:100vh;
    }
    header{
      padding:18px 16px 10px;
      text-align:center;
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background: rgba(7,15,24,.55);
      border-bottom:1px solid rgba(27,60,92,.5);
      z-index:10;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px}

    .wrap{max-width:980px;margin:0 auto;padding:14px 12px 40px}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding:12px 0 10px;
    }
    .tabbtn{
      border:1px solid rgba(27,60,92,.7);
      background: rgba(15,36,55,.65);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      box-shadow: var(--shadow);
    }
    .tabbtn.active{
      background: linear-gradient(180deg, rgba(43,99,255,.95), rgba(43,99,255,.6));
      border-color: rgba(43,99,255,.9);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:900px){
      .grid.two{grid-template-columns: 1.2fr .8fr}
      .grid.three{grid-template-columns: 1fr 1fr 1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(15,36,55,.92), rgba(11,29,46,.92));
      border:1px solid rgba(27,60,92,.65);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 8px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}
    textarea, input, select{
      width:100%;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(27,60,92,.8);
      background: rgba(8,26,42,.8);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{min-height:120px;resize:vertical}
    .btn{
      border:none;
      background: linear-gradient(180deg, rgba(43,99,255,1), rgba(43,99,255,.65));
      color:#fff;
      font-weight:800;
      padding:11px 14px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: var(--shadow);
      width:100%;
    }
    .btn.secondary{
      background: rgba(15,36,55,.75);
      border:1px solid rgba(27,60,92,.8);
      color:var(--text);
    }
    .btn.danger{
      background: rgba(255,92,92,.18);
      border:1px solid rgba(255,92,92,.65);
      color:#ffd6d6;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(27,60,92,.8);
      background: rgba(8,26,42,.6);
      color:var(--muted);
      margin-left:6px;
      white-space:nowrap;
    }
    .pill.blue{border-color: rgba(43,99,255,.7); color:#cfe0ff}
    .pill.food{border-color: rgba(57,217,138,.5); color:#c9ffe7}
    .pill.add{border-color: rgba(255,196,87,.5); color:#ffe6b6}
    .pill.bad{border-color: rgba(255,92,92,.7); color:#ffd6d6}
    .pill.good{border-color: rgba(57,217,138,.7); color:#c9ffe7}

    .result{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(27,60,92,.65);
      background: rgba(8,26,42,.6);
      margin-top:10px;
    }
    .status{
      font-weight:900;
      letter-spacing:.2px;
      margin-top:6px;
    }
    .safe{color:var(--green)}
    .bad{color:var(--red)}
    .why{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.35}
    .why b{color:#dbe7ff}
    details{
      border:1px solid rgba(27,60,92,.65);
      border-radius:14px;
      background: rgba(8,26,42,.6);
      padding:10px 12px;
    }
    summary{cursor:pointer;font-weight:800}
    .divider{height:1px;background:rgba(27,60,92,.6);margin:10px 0}

    .kpi{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }
    .kpi .box{
      flex:1;
      min-width:150px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(27,60,92,.65);
      background: rgba(8,26,42,.55);
    }
    .kpi .box .label{color:var(--muted);font-size:12px}
    .kpi .box .val{font-weight:900;font-size:16px;margin-top:2px}

    .mini{
      font-size:12px;color:var(--muted);
      line-height:1.35;margin-top:8px
    }
    .list{
      margin:8px 0 0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.35
    }
    .tagline{margin-top:6px;color:var(--muted);font-size:12px}

    .stickyActions{
      position: sticky;
      bottom: 10px;
      margin-top: 10px;
      z-index: 5;
    }
    .actionsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(min-width:900px){
      .actionsGrid{grid-template-columns: 1fr 1fr 1fr}
    }
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(15,36,55,.95);
      border:1px solid rgba(27,60,92,.75);
      color: var(--text);
      padding:10px 14px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-weight:800;
      display:none;
      z-index: 50;
      max-width: 92vw;
      text-align:center;
    }
  </style>
</head>

<body>
<header>
  <h1>Pet Peeves – Ollie & Coco</h1>
  <div class="sub">Ultra scanner + meal planning + grocery + saved meals • Moderate/High = NOT SAFE • Food + Additives merged</div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tabbtn active" data-tab="scanner">Scanner</button>
    <button class="tabbtn" data-tab="planner">Meal Planner</button>
    <button class="tabbtn" data-tab="directory">Directory</button>
    <button class="tabbtn" data-tab="saved">Saved Meals</button>
    <button class="tabbtn" data-tab="history">History</button>
  </div>

  <!-- SCANNER TAB -->
  <section id="scanner" class="grid two">
    <div class="card">
      <h2>Ingredient Scanner <span class="pill blue">Food + Additives</span></h2>
      <div class="muted">
        Paste ingredients from a label or iPhone text extraction. Handles parentheses, plurals, and word order
        (e.g., <b>green pepper</b> ⇄ <b>pepper - green</b>).
      </div>

      <textarea id="scanInput" placeholder="Paste ingredients here...
Example: chicken, brown rice, green bell peppers, calcium carbonate (to maintain freshness)"></textarea>

      <div class="stickyActions">
        <div class="actionsGrid">
          <button class="btn" id="scanBtn">Analyze</button>
          <button class="btn secondary" id="demoBtn">Demo</button>
          <button class="btn secondary" id="clearScanBtn">Clear</button>
        </div>
        <div class="tagline">Tip: commas, semicolons, and line breaks all work.</div>
      </div>

      <div id="scanResults"></div>
    </div>

    <div class="card">
      <h2>Quick Tips</h2>
      <ul class="list">
        <li><b>Parentheses are ignored:</b> “calcium carbonate (freshness)” still matches “calcium carbonate”.</li>
        <li><b>Plural-safe:</b> “carrots” matches “carrot”.</li>
        <li><b>Order-safe:</b> “green pepper” matches “pepper green”.</li>
        <li><b>Family reminders:</b> typing “rice” warns if only a specific rice variant is an issue.</li>
      </ul>

      <div class="divider"></div>

      <details>
        <summary>Why “rice” doesn’t auto-fail everything</summary>
        <div class="mini">
          “Rice” is a family. “Rice flour”, “brown rice”, and “white rice” can be different.
          The scanner avoids false positives by matching the most specific variant possible, then gives a reminder.
        </div>
      </details>

      <div class="divider"></div>

      <details>
        <summary>Add your own safe item for meal planning</summary>
        <div class="mini">
          If you want, you can add items to the safe pools in the Meal Planner tab (it will still auto-block banned items).
        </div>
      </details>
    </div>
  </section>

  <!-- PLANNER TAB -->
  <section id="planner" class="hidden">
    <div class="grid two">
      <div class="card">
        <h2>Meal Planner <span class="pill blue">US units</span></h2>
        <div class="muted">
          Builds shared meals using dog-safe ingredients and filters out anything that is Moderate/High for either dog.
        </div>

        <div class="row">
          <div>
            <div class="mini">Coco weight (lbs)</div>
            <input id="cocoLbs" type="number" min="1" value="55" />
          </div>
          <div>
            <div class="mini">Ollie weight (lbs)</div>
            <input id="ollieLbs" type="number" min="1" value="65" />
          </div>
        </div>

        <div class="row">
          <div>
            <div class="mini">Activity</div>
            <select id="activitySel">
              <option value="1.2">Low</option>
              <option value="1.4" selected>Moderate</option>
              <option value="1.6">Active</option>
            </select>
          </div>
          <div>
            <div class="mini">Meals / day</div>
            <select id="mealsPerDay">
              <option>1</option>
              <option selected>2</option>
              <option>3</option>
            </select>
          </div>
          <div>
            <div class="mini">Batch days (up to 7)</div>
            <select id="batchDays">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>5</option>
              <option selected>7</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <details open>
          <summary>Safe Pools (editable)</summary>
          <div class="mini">Add items (comma-separated). Planner will still block anything banned.</div>
          <div class="divider"></div>

          <div class="mini">Proteins</div>
          <input id="poolProteins" value="chicken, turkey, lamb, bison, sardine, whitefish" />

          <div class="mini" style="margin-top:10px;">Carbs / grains</div>
          <input id="poolCarbs" value="brown rice, quinoa, oats, barley, pumpkin" />

          <div class="mini" style="margin-top:10px;">Veggies</div>
          <input id="poolVeg" value="zucchini, green beans, spinach, broccoli, peas" />

          <div class="mini" style="margin-top:10px;">Fats / oils</div>
          <input id="poolFats" value="salmon oil, fish oil, sunflower oil" />

          <div class="mini" style="margin-top:10px;">Flavor boosters (dog-safe)</div>
          <input id="poolFlavors" value="pumpkin puree, bone broth, carrot puree, apple, blueberries, parsley, turmeric" />

          <div class="mini" style="margin-top:10px;">Liquids (for measuring)</div>
          <input id="poolLiquids" value="bone broth, water" />
        </details>

        <div class="divider"></div>

        <div class="grid three">
          <button class="btn" id="genMealBtn">Generate Meal</button>
          <button class="btn secondary" id="exportGroceryBtn">Export Grocery List</button>
          <button class="btn secondary" id="saveMealBtn">Save Meal</button>
        </div>

        <div id="mealOut"></div>
      </div>

      <div class="card">
        <h2>Grocery List <span class="pill blue">batch aware</span></h2>
        <div class="muted">Auto-populated from the generated meal. Toggle categories and export.</div>

        <div class="row" style="margin-top:10px;">
          <label class="pill food"><input type="checkbox" id="togProtein" checked style="margin-right:6px;">Proteins</label>
          <label class="pill food"><input type="checkbox" id="togCarb" checked style="margin-right:6px;">Carbs</label>
          <label class="pill food"><input type="checkbox" id="togVeg" checked style="margin-right:6px;">Veggies</label>
          <label class="pill food"><input type="checkbox" id="togFat" checked style="margin-right:6px;">Fats</label>
          <label class="pill food"><input type="checkbox" id="togFlavor" checked style="margin-right:6px;">Flavors</label>
          <label class="pill food"><input type="checkbox" id="togLiquid" checked style="margin-right:6px;">Liquids</label>
        </div>

        <div id="groceryOut" style="margin-top:12px;"></div>

        <div class="divider"></div>

        <details>
          <summary>Cooking notes</summary>
          <ul class="list">
            <li>Cook protein thoroughly; no seasoning, onion, garlic, or xylitol products.</li>
            <li>Cook carbs plain. Steam veggies lightly.</li>
            <li>Add oils and flavor boosters after cooling.</li>
            <li>Refrigerate 3–4 days; freeze the rest.</li>
          </ul>
        </details>
      </div>
    </div>
  </section>

  <!-- DIRECTORY TAB -->
  <section id="directory" class="hidden">
    <div class="card">
      <h2>Master Reaction Directory <span class="pill bad">Only reactions</span></h2>
      <div class="muted">Searchable list of everything Coco/Ollie react to (Foods + Additives). Moderate/High shown with tags.</div>
      <input id="dirSearch" placeholder="Search (e.g., beef, pepper, E 221, calcium carbonate)" />
      <div id="dirOut" style="margin-top:12px;"></div>
    </div>
  </section>

  <!-- SAVED TAB -->
  <section id="saved" class="hidden">
    <div class="card">
      <h2>Saved Meals</h2>
      <div class="muted">Saved to this device (localStorage). Includes grocery list + instructions.</div>
      <div class="divider"></div>
      <div id="savedOut"></div>
      <div class="divider"></div>
      <button class="btn danger" id="clearSavedBtn">Clear All Saved Meals</button>
    </div>
  </section>

  <!-- HISTORY TAB -->
  <section id="history" class="hidden">
    <div class="card">
      <h2>Scan History</h2>
      <div class="muted">Stores your last scans on this device. Helpful for comparing foods.</div>
      <div class="divider"></div>
      <div id="histOut"></div>
      <div class="divider"></div>
      <button class="btn secondary" id="clearHistBtn">Clear History</button>
    </div>
  </section>

</div>

<div id="toast" class="toast"></div>

<script>
/* =========================================================
   ✅ ULTRA-INTELLECT CORE
   - merged foods + additives
   - plural/order/parentheses/OCR resilient
   - family reminders (rice, yogurt, peppers, etc.)
   - meal planner with filtering + grocery + export + save
   ========================================================= */

/* ---------------------------
   1) REACTION DATA (Foods)
   --------------------------- */

const FOOD = {
  coco: {
    high: [
      "Canola Oil","Chia Seeds","Clove","Haddock","Herring","Mozzarella","Paprika","Peach",
      "Rabbit","Rabbit Heart","Rabbit Liver","Rapeseed oil","Sugar (brown)","Sweet Potato","Tahini"
    ],
    moderate: [
      "Ammonium Laureth Sulfate","Beef","Bilberry","Cheese - Cheddar","Chlorella","Coconut",
      "Cornflakes","Egg Yolk - Chicken","Egg Yolk - Duck","Hare","Iceberg lettuce","Lemon",
      "Pecan nut","Pepper - green","Psyllium Seed Husk","Strawberry","Turnip","Winkles"
    ]
  },
  ollie: {
    high: [
      "Avocado oil","Boar","Buttermilk","Canola Meal","Coconut","Coconut Oil","Crab","Duck Liver",
      "Noodles - wheat","Papaya","Parmesan","Prawn","Sage","Strawberry","Tapioca","Venison Meal"
    ],
    moderate: [
      "Anchovy","Catfish","Cheese - Cottage","Chicken Heart","Condensed milk","Cream","Egg White - Chicken",
      "Emmer wheat","Farina secalis cerealis","Ginkgo biloba","Greens (Collard)","Lamb Liver","Liver - ox",
      "Milkweed","Onion","Pepper - green","Pheasant Gizzard","Pigeon","Raisin","Skate","Soy Flour",
      "Sweet Potato","Tilefish","Winkles"
    ]
  }
};

/* ------------------------------
   2) REACTION DATA (Additives)
   (from your pasted lists)
   ------------------------------ */
const ADD = {
  coco: {
    high: [
      "E 110 Sunset Yellow","E 160 b Annatto","E 180 Lithol Rubine BK","E 221 Sodium sulphite",
      "E 332 Potassium citrate","E 483 Stearyl tartrate","E 576 Sodium gluconate","E 620 Glutamic acid",
      "E 959 Neohesperidine DC","Rose (Rosa spp.)"
    ],
    moderate: [
      "Artichoke leaf extract","E 200 Sorbic acid","E 233 Thiabendazole","E 312 Dodecyl gallate",
      "E 340 Potassium phosphate","E 411 Xantham gum","E 528 Magnesium hydroxide","E 535 Sodium ferrocyanide",
      "E 624 Monoammonium glutamate","E 629 Calcium guanylate","E 630 Inosinic acid","E 927 Azodicarbonamide",
      "Rosemary Extract"
    ]
  },
  ollie: {
    high: [
      "E 141 Copper complexes of chlorophyll","E 150 d Sulphite Ammonia Caramel","E 160 e Beta-apo-8'-carotenal",
      "E 162 Beetroot red","E 218 Methyl p-hydroxybenzoate","E 242 Dimethyl dicarbonate","E 260 Acetic acid",
      "E 263 Calcium acetate","E 270 Lactic acid","E 335 Sodium tartrate","E 472 d Tartaric acid esters of mono- and diglycerides",
      "E 473 Sucrose esters of fatty acids","E 477 Propylene glycol esters of fatty acids","E 522 Aluminium potassium sulphate",
      "E 541 Sodium aluminium phosphate","E 630 Inosinic acid","E 941 Nitrogen","E 951 Aspartame",
      "Formic acid","Pepsin","Tartaric acid"
    ],
    moderate: [
      "E 150 c Ammonia Caramel","E 1520 Propylene glycol","E 249 Potassium nitrite","E 284 Boric acid",
      "E 312 Dodecyl gallate","E 334 Tartaric acid","E 353 Metatartaric acid","E 354 Calcium tartrate",
      "E 472 e Mono- and diacetyltartaric acid esters of mono- and diglycerides","E 476 Polyglycerol polyricinoleate",
      "E 554 Sodium aluminosilicate","E 621 Monosodium glutamate","E 634 Calcium 5'-ribonucleotides",
      "E 902 Candelilla wax","E 903 Carnauba wax","Formalin"
    ]
  }
};

/* ---------------------------------------
   3) Family reminders + alias handling
   --------------------------------------- */

// If user types "rice", we DON'T auto-fail. We show reminders if a variant is banned.
// Similarly "yogurt" vs "yogurt (plain)", "pepper" vs "pepper green", etc.
const FAMILY = [
  { key:"rice", variants:["brown rice","white rice","rice flour","rice bran","brewers rice"] },
  { key:"yogurt", variants:["yogurt plain","yogurt (plain)","plain yogurt"] },
  { key:"pepper", variants:["pepper green","green pepper","green bell pepper","bell pepper green","pepper white","pepper black","pepper red"] },
  { key:"cheese", variants:["cheese cheddar","cheese cottage","cheese swiss","cheese american","cheese parmesan","parmesan"] },
  { key:"egg", variants:["egg white chicken","egg yolk chicken","egg yolk duck","egg white duck"] }
];

// Alias map: normalize common variants into canonical-ish tokens
const ALIASES = {
  "green peppers":"green pepper",
  "bell peppers":"bell pepper",
  "green bell peppers":"green bell pepper",
  "pepper - green":"green pepper",
  "pepper green":"green pepper",
  "greens (collard)":"collard greens",
  "cheese - cottage":"cottage cheese",
  "cheese - cheddar":"cheddar cheese",
  "yogurt (plain)":"plain yogurt",
  "e221":"e 221",
  "e-221":"e 221",
  "e 221 sodium sulphite":"e 221 sodium sulphite",
};

/* -------------------------
   4) Normalization helpers
   ------------------------- */

function stripParens(s){ return s.replace(/\([^)]*\)/g," "); }

// light OCR cleanup + punctuation handling
function normalizeRaw(s){
  return stripParens(String(s||""))
    .toLowerCase()
    .replace(/[•·]/g," ")
    .replace(/[\u2013\u2014]/g,"-")
    .replace(/[^a-z0-9\s\-]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

// naive singularization (good enough for labels)
function singularizeWord(w){
  if(w.length<=3) return w;
  if(w.endsWith("ies")) return w.slice(0,-3)+"y";
  if(w.endsWith("sses")) return w.slice(0,-2);
  if(w.endsWith("s") && !w.endsWith("ss")) return w.slice(0,-1);
  return w;
}

function normalizeKey(s){
  let t = normalizeRaw(s);

  // apply alias replacements if exact string present
  if(ALIASES[t]) t = ALIASES[t];

  // normalize common "E###" patterns
  t = t.replace(/\be\s*0*([0-9]{2,4})\b/g, (m,n)=>`e ${n}`);

  // remove hyphens as separators but keep spacing
  t = t.replace(/\-/g," ");

  // singularize tokens
  const parts = t.split(" ").filter(Boolean).map(singularizeWord);

  // re-apply alias after singularization if it now matches
  const joined = parts.join(" ");
  return ALIASES[joined] ? ALIASES[joined] : joined;
}

function tokens(s){
  return new Set(normalizeKey(s).split(" ").filter(Boolean));
}

function tokenIncludesAll(hayTokens, needleTokens){
  for(const n of needleTokens){ if(!hayTokens.has(n)) return false; }
  return true;
}

/* -------------------------------------------
   5) Build merged banned index (food+add)
   ------------------------------------------- */

function buildBannedIndex(){
  const idx = []; // {type, dog, level, label, keyTokens, keyString}
  const addItems = (type, dog, level, arr) => {
    arr.forEach(label=>{
      const key = normalizeKey(label);
      idx.push({
        type, dog, level,
        label,
        keyString: key,
        keyTokens: tokens(key)
      });
    });
  };

  addItems("Food","Coco","High",FOOD.coco.high);
  addItems("Food","Coco","Moderate",FOOD.coco.moderate);
  addItems("Food","Ollie","High",FOOD.ollie.high);
  addItems("Food","Ollie","Moderate",FOOD.ollie.moderate);

  addItems("Additive","Coco","High",ADD.coco.high);
  addItems("Additive","Coco","Moderate",ADD.coco.moderate);
  addItems("Additive","Ollie","High",ADD.ollie.high);
  addItems("Additive","Ollie","Moderate",ADD.ollie.moderate);

  return idx;
}

const BANNED = buildBannedIndex();

/* -------------------------------------------
   6) Matching engine (ULTRA)
   - exact token set match
   - order independent
   - plural independent
   - parentheses independent
   - family reminders for broad terms
   ------------------------------------------- */

function findMatchesForIngredient(rawText){
  const cleaned = normalizeKey(rawText);

  // If cleaned becomes empty, skip
  if(!cleaned) return { cleaned:"", hits:[], reminders:[] };

  const inputTokens = tokens(cleaned);

  // exact-ish: banned entry tokens must be subset of input tokens
  const hits = [];
  for(const item of BANNED){
    if(tokenIncludesAll(inputTokens, item.keyTokens)){
      hits.push(item);
    }
  }

  // Family reminders: if user typed a family key but did NOT match a specific banned variant,
  // we check if any variants are banned and remind without auto failing.
  const reminders = [];
  const inputStr = cleaned;

  for(const fam of FAMILY){
    const famKey = normalizeKey(fam.key);
    const famKeyTokens = tokens(famKey);

    // user typed the family keyword (e.g., "rice")
    // We accept if input contains the fam key tokens
    if(tokenIncludesAll(inputTokens, famKeyTokens)){
      // If already matched a specific banned item that contains that fam keyword, we don't need reminder
      const alreadyHitFamily = hits.some(h => h.keyString.includes(famKey));
      if(alreadyHitFamily) continue;

      // Find banned variants for this family
      const bannedVariants = [];
      for(const v of fam.variants){
        const vKey = normalizeKey(v);
        // Is this specific variant in BANNED list?
        const isVariantBanned = BANNED.some(b => b.keyString === vKey || tokenIncludesAll(tokens(b.keyString), tokens(vKey)) && tokenIncludesAll(tokens(vKey), tokens(b.keyString)));
        if(isVariantBanned){
          // pull exact banned entries that match variant tokens (for dog/level info)
          const vTokens = tokens(vKey);
          const vHits = BANNED.filter(b => tokenIncludesAll(vTokens, b.keyTokens) || tokenIncludesAll(b.keyTokens, vTokens));
          vHits.forEach(x => bannedVariants.push(x));
        }
      }

      if(bannedVariants.length){
        // de-dupe
        const uniq = [];
        const seen = new Set();
        for(const b of bannedVariants){
          const k = `${b.type}|${b.dog}|${b.level}|${b.keyString}`;
          if(!seen.has(k)){ seen.add(k); uniq.push(b); }
        }

        reminders.push({
          family: fam.key,
          message: `Reminder: "${fam.key}" can appear in different forms. You may be fine with some, but not others.`,
          variants: uniq
        });
      }
    }
  }

  return { cleaned, hits, reminders };
}

function statusFromHits(hits){
  // Moderate/High are both NOT SAFE (per your rules)
  if(!hits.length) return "SAFE";
  return "NOT_SAFE";
}

/* -------------------------------------------
   7) Scanner parsing
   ------------------------------------------- */

function splitIngredients(text){
  const t = String(text||"");
  // Keep E-numbers etc, but split on common separators
  return t
    .replace(/\r/g,"\n")
    .split(/,|;|\n|\t/gi)
    .map(s=>s.trim())
    .filter(Boolean);
}

/* -------------------------------------------
   8) UI helpers
   ------------------------------------------- */

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 1600);
}

function esc(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function pillForType(type){
  return type==="Additive" ? `<span class="pill add">Additive</span>` : `<span class="pill food">Food</span>`;
}
function pillForLevel(level){
  const cls = "bad";
  return `<span class="pill ${cls}">${esc(level)}</span>`;
}
function pillForDog(dog){
  return `<span class="pill blue">${esc(dog)}</span>`;
}

/* -------------------------------------------
   9) Scanner render + history
   ------------------------------------------- */

const HIST_KEY = "petpeeves_history_v1";
function loadHistory(){
  try{ return JSON.parse(localStorage.getItem(HIST_KEY)||"[]"); }catch{ return []; }
}
function saveHistory(arr){
  localStorage.setItem(HIST_KEY, JSON.stringify(arr.slice(0,25)));
}

function renderHistory(){
  const hist = loadHistory();
  const out = document.getElementById("histOut");
  if(!hist.length){
    out.innerHTML = `<div class="muted">No history yet.</div>`;
    return;
  }
  out.innerHTML = hist.map((h,i)=>`
    <div class="result">
      <div style="font-weight:900">${esc(h.title||"Scan")} <span class="pill blue">${new Date(h.ts).toLocaleString()}</span></div>
      <div class="mini">${esc(h.preview||"")}</div>
      <div class="divider"></div>
      <button class="btn secondary" onclick="restoreHistory(${i})">Load into scanner</button>
    </div>
  `).join("");
}
function restoreHistory(i){
  const hist = loadHistory();
  const item = hist[i];
  if(!item) return;
  document.getElementById("scanInput").value = item.raw || "";
  toast("Loaded scan into Scanner");
  document.querySelector('[data-tab="scanner"]').click();
}

function runScan(raw){
  const list = splitIngredients(raw);
  const results = [];

  for(const ing of list){
    const m = findMatchesForIngredient(ing);
    if(!m.cleaned) continue;

    // hits de-dupe
    const uniqHits = [];
    const seen = new Set();
    for(const h of m.hits){
      const k = `${h.type}|${h.dog}|${h.level}|${h.keyString}`;
      if(!seen.has(k)){ seen.add(k); uniqHits.push(h); }
    }

    const status = statusFromHits(uniqHits);
    results.push({ original: ing, cleaned: m.cleaned, hits: uniqHits, reminders: m.reminders, status });
  }

  return results;
}

function renderScan(results){
  const out = document.getElementById("scanResults");
  if(!results.length){
    out.innerHTML = `<div class="result"><div class="muted">Nothing to analyze yet.</div></div>`;
    return;
  }

  const unsafeCount = results.filter(r=>r.status==="NOT_SAFE").length;
  const safeCount = results.length - unsafeCount;

  const summary = `
    <div class="kpi">
      <div class="box"><div class="label">Total items</div><div class="val">${results.length}</div></div>
      <div class="box"><div class="label">NOT SAFE</div><div class="val" style="color:var(--red)">${unsafeCount}</div></div>
      <div class="box"><div class="label">SAFE</div><div class="val" style="color:var(--green)">${safeCount}</div></div>
    </div>
  `;

  const rows = results.map(r=>{
    const tag = r.hits.length ? (r.hits[0].type==="Additive" ? "Additive" : "Food") : "Auto";
    const tagPill = tag==="Additive" ? `<span class="pill add">Additive</span>` : `<span class="pill food">Food</span>`;

    const statusHtml = r.status==="SAFE"
      ? `<div class="status safe">SAFE</div>`
      : `<div class="status bad">NOT SAFE</div>`;

    const hitHtml = r.hits.length ? `
      <div class="why">
        ${r.hits.map(h=>`
          <div style="margin-top:6px;">
            ${pillForDog(h.dog)} ${pillForLevel(h.level)} ${pillForType(h.type)}
            <div class="mini"><b>Matched:</b> ${esc(h.label)}</div>
          </div>
        `).join("")}
      </div>
    ` : `<div class="why">No direct match found in reaction lists.</div>`;

    const remindersHtml = r.reminders && r.reminders.length ? `
      <details style="margin-top:10px;">
        <summary>Family reminder(s)</summary>
        ${r.reminders.map(rem=>`
          <div class="mini" style="margin-top:8px;"><b>${esc(rem.family)}:</b> ${esc(rem.message)}</div>
          <div class="mini" style="margin-top:6px;"><b>Known reactive variants:</b></div>
          ${rem.variants.map(v=>`
            <div class="mini" style="margin-top:6px;">
              ${pillForDog(v.dog)} ${pillForLevel(v.level)} ${pillForType(v.type)}
              <span class="mini">${esc(v.label)}</span>
            </div>
          `).join("")}
        `).join("")}
      </details>
    ` : "";

    return `
      <div class="result">
        <div style="font-weight:900;font-size:15px;">
          ${esc(r.original)} ${tagPill}
        </div>
        <div class="mini"><b>Normalized:</b> ${esc(r.cleaned)}</div>
        ${statusHtml}
        ${hitHtml}
        ${remindersHtml}
      </div>
    `;
  }).join("");

  out.innerHTML = summary + rows;
}

function addHistory(raw, results){
  const preview = splitIngredients(raw).slice(0,8).join(", ");
  const title = `${results.filter(r=>r.status==="NOT_SAFE").length} flagged • ${results.length} total`;
  const hist = loadHistory();
  hist.unshift({ ts: Date.now(), raw, preview, title });
  saveHistory(hist);
  renderHistory();
}

/* -------------------------------------------
   10) Directory (searchable)
   ------------------------------------------- */

function buildDirectoryRows(){
  // Combine banned list and de-dupe by normalized keyString + dog + level + type
  const seen = new Set();
  const rows = [];
  for(const b of BANNED){
    const k = `${b.type}|${b.dog}|${b.level}|${b.keyString}`;
    if(seen.has(k)) continue;
    seen.add(k);
    rows.push(b);
  }
  // sort nicer: Food first, then Additives, then dog, then level
  const levelRank = {High:0,Moderate:1};
  rows.sort((a,b)=>{
    const t = (a.type===b.type)?0:(a.type==="Food"?-1:1);
    if(t) return t;
    const d = a.dog.localeCompare(b.dog); if(d) return d;
    const l = (levelRank[a.level]??9) - (levelRank[b.level]??9); if(l) return l;
    return a.keyString.localeCompare(b.keyString);
  });
  return rows;
}
const DIR_ROWS = buildDirectoryRows();

function renderDirectory(filter=""){
  const q = normalizeKey(filter);
  const out = document.getElementById("dirOut");

  const rows = !q ? DIR_ROWS : DIR_ROWS.filter(r=>{
    const hay = r.keyString + " " + normalizeKey(r.label) + " " + r.type.toLowerCase() + " " + r.dog.toLowerCase() + " " + r.level.toLowerCase();
    return hay.includes(q);
  });

  if(!rows.length){
    out.innerHTML = `<div class="result"><div class="muted">No matches.</div></div>`;
    return;
  }

  out.innerHTML = rows.map(r=>`
    <div class="result">
      <div style="font-weight:900">
        ${esc(r.label)}
        ${pillForDog(r.dog)} ${pillForLevel(r.level)} ${pillForType(r.type)}
      </div>
      <div class="mini"><b>Normalized key:</b> ${esc(r.keyString)}</div>
    </div>
  `).join("");
}

/* -------------------------------------------
   11) Meal Planner (shared safe + filtering)
   ------------------------------------------- */

const MEAL_KEY = "petpeeves_savedmeals_v2";

function loadMeals(){ try{ return JSON.parse(localStorage.getItem(MEAL_KEY)||"[]"); }catch{ return []; } }
function saveMeals(arr){ localStorage.setItem(MEAL_KEY, JSON.stringify(arr)); }

function isBanned(itemText){
  const m = findMatchesForIngredient(itemText);
  return m.hits && m.hits.length;
}

function parsePool(inputId){
  return String(document.getElementById(inputId).value||"")
    .split(",")
    .map(s=>s.trim())
    .filter(Boolean);
}

function chooseFromPool(items){
  const safe = items.filter(x=>!isBanned(x));
  if(!safe.length) return null;
  return safe[Math.floor(Math.random()*safe.length)];
}

// Basic feeding estimate (simple & practical):
// daily food oz ≈ (total_lbs * 0.4 oz/lb) * activity
// then convert to cups assuming ~4 oz per cup (rough average for mixed cooked food)
// This is *not* veterinary dosing; it’s a starting point.
function calcDailyFoodOz(totalLbs, activityMult){
  const base = totalLbs * 0.4; // oz/day per lb
  return base * activityMult;
}

function buildMeal(){
  const coco = parseFloat(document.getElementById("cocoLbs").value||"0");
  const ollie = parseFloat(document.getElementById("ollieLbs").value||"0");
  const totalLbs = coco + ollie;

  const activity = parseFloat(document.getElementById("activitySel").value||"1.4");
  const mealsPerDay = parseInt(document.getElementById("mealsPerDay").value||"2",10);
  const days = Math.min(7, Math.max(1, parseInt(document.getElementById("batchDays").value||"7",10)));

  const proteins = parsePool("poolProteins");
  const carbs = parsePool("poolCarbs");
  const veg = parsePool("poolVeg");
  const fats = parsePool("poolFats");
  const flavors = parsePool("poolFlavors");
  const liquids = parsePool("poolLiquids");

  const picked = {
    protein: chooseFromPool(proteins),
    carb: chooseFromPool(carbs),
    veg: chooseFromPool(veg),
    fat: chooseFromPool(fats),
    flavor: chooseFromPool(flavors),
    liquid: chooseFromPool(liquids)
  };

  // If any category has zero safe options, we still return and explain.
  const missing = Object.entries(picked).filter(([k,v])=>!v).map(([k])=>k);

  const dailyOz = calcDailyFoodOz(totalLbs, activity);
  const perMealOz = dailyOz / mealsPerDay;
  const batchOz = dailyOz * days;

  // Meal composition ratios (simple):
  // Protein 50%, Carb 25%, Veg 15%, Fat 5%, Flavor/Liquid 5%
  const ratios = { protein:.50, carb:.25, veg:.15, fat:.05, flavor:.03, liquid:.02 };

  const qty = {};
  for(const k of Object.keys(ratios)){
    qty[k] = batchOz * ratios[k];
  }

  // Convert oz to lbs and cups (approx 4 oz per cup)
  function fmtOz(x){ return `${x.toFixed(1)} oz`; }
  function fmtLb(x){ return `${(x/16).toFixed(2)} lb`; }
  function fmtCups(x){ return `${(x/4).toFixed(2)} cups`; }

  const grocery = [
    {cat:"Proteins", key:"protein", item:picked.protein, oz:qty.protein},
    {cat:"Carbs", key:"carb", item:picked.carb, oz:qty.carb},
    {cat:"Veggies", key:"veg", item:picked.veg, oz:qty.veg},
    {cat:"Fats", key:"fat", item:picked.fat, oz:qty.fat},
    {cat:"Flavors", key:"flavor", item:picked.flavor, oz:qty.flavor},
    {cat:"Liquids", key:"liquid", item:picked.liquid, oz:qty.liquid},
  ].filter(x=>x.item);

  const instructions = [
    `Cook ${picked.protein||"protein"} thoroughly (no seasoning, no onion/garlic).`,
    `Cook ${picked.carb||"carb"} plain. Steam ${picked.veg||"veg"} lightly.`,
    `Cool, then mix. Add ${picked.fat||"oil"} after cooling.`,
    `Stir in ${picked.flavor||"flavor booster"} and ${picked.liquid||"liquid"} as needed for texture.`,
    `Portion into ${mealsPerDay} meals/day. Refrigerate 3–4 days, freeze the rest.`
  ];

  return {
    coco, ollie, totalLbs, activity, mealsPerDay, days,
    picked, missing,
    dailyOz, perMealOz, batchOz,
    qty, grocery, instructions
  };
}

function renderMeal(meal){
  const out = document.getElementById("mealOut");

  const approxDailyCups = meal.dailyOz/4;
  const approxPerMealCups = (meal.dailyOz/meal.mealsPerDay)/4;

  const missingHtml = meal.missing.length ? `
    <div class="result">
      <div class="status bad">Planner issue</div>
      <div class="why">No safe options available in: <b>${meal.missing.join(", ")}</b>. Edit Safe Pools and try again.</div>
    </div>
  ` : "";

  const mealHtml = `
    <div class="result">
      <div style="font-weight:900;font-size:15px;">Suggested Shared Meal <span class="pill good">Auto-safe</span></div>
      <div class="divider"></div>

      <div class="row">
        <div class="kpi" style="margin-top:0">
          <div class="box"><div class="label">Daily total</div><div class="val">${meal.dailyOz.toFixed(1)} oz <span class="mini">(~${approxDailyCups.toFixed(2)} cups)</span></div></div>
          <div class="box"><div class="label">Per meal</div><div class="val">${meal.perMealOz.toFixed(1)} oz <span class="mini">(~${approxPerMealCups.toFixed(2)} cups)</span></div></div>
          <div class="box"><div class="label">Batch</div><div class="val">${meal.batchOz.toFixed(0)} oz <span class="mini">(${(meal.batchOz/16).toFixed(2)} lb)</span></div></div>
        </div>
      </div>

      <div class="divider"></div>

      <div style="font-weight:900">Meal components</div>
      <div class="mini">
        <b>Protein:</b> ${esc(meal.picked.protein||"—")}<br>
        <b>Carb:</b> ${esc(meal.picked.carb||"—")}<br>
        <b>Veg:</b> ${esc(meal.picked.veg||"—")}<br>
        <b>Fat:</b> ${esc(meal.picked.fat||"—")}<br>
        <b>Flavor:</b> ${esc(meal.picked.flavor||"—")}<br>
        <b>Liquid:</b> ${esc(meal.picked.liquid||"—")}
      </div>

      <div class="divider"></div>

      <details open>
        <summary>Cooking instructions</summary>
        <ul class="list">
          ${meal.instructions.map(s=>`<li>${esc(s)}</li>`).join("")}
        </ul>
      </details>
    </div>
  `;

  out.innerHTML = missingHtml + mealHtml;
}

function groceryText(meal){
  const lines = [];
  lines.push(`Pet Peeves – Grocery List (${meal.days} day batch)`);
  lines.push(`Coco ${meal.coco} lb • Ollie ${meal.ollie} lb • Activity x${meal.activity} • ${meal.mealsPerDay} meals/day`);
  lines.push(`---`);
  for(const g of meal.grocery){
    lines.push(`${g.cat}: ${g.item} — ${g.oz.toFixed(1)} oz (${(g.oz/16).toFixed(2)} lb) ~ ${(g.oz/4).toFixed(2)} cups`);
  }
  lines.push(`---`);
  lines.push(`Notes: No onion/garlic/xylitol. Oils after cooling. Refrigerate 3–4 days; freeze the rest.`);
  return lines.join("\n");
}

function renderGrocery(meal){
  const out = document.getElementById("groceryOut");
  if(!meal || !meal.grocery) { out.innerHTML = `<div class="muted">Generate a meal to see grocery list.</div>`; return; }

  const toggles = {
    Proteins: document.getElementById("togProtein").checked,
    Carbs: document.getElementById("togCarb").checked,
    Veggies: document.getElementById("togVeg").checked,
    Fats: document.getElementById("togFat").checked,
    Flavors: document.getElementById("togFlavor").checked,
    Liquids: document.getElementById("togLiquid").checked,
  };

  const rows = meal.grocery
    .filter(g => toggles[g.cat] !== false)
    .map(g=>`
      <div class="result">
        <div style="font-weight:900">${esc(g.item)} <span class="pill food">${esc(g.cat)}</span></div>
        <div class="mini"><b>Batch amount:</b> ${g.oz.toFixed(1)} oz • ${(g.oz/16).toFixed(2)} lb • ~ ${(g.oz/4).toFixed(2)} cups</div>
      </div>
    `).join("");

  out.innerHTML = rows || `<div class="muted">All categories toggled off.</div>`;
}

function exportGrocery(meal){
  const txt = groceryText(meal);
  navigator.clipboard?.writeText(txt).then(()=>{
    toast("Grocery list copied");
  }).catch(()=>{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    toast("Grocery list copied");
  });
}

function saveMeal(meal){
  if(!meal) return;
  const meals = loadMeals();
  const name = `Meal • ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString().slice(0,5)}`;
  meals.unshift({
    id: crypto?.randomUUID?.() || String(Date.now()),
    name,
    ts: Date.now(),
    meal
  });
  saveMeals(meals.slice(0,40));
  renderSaved();
  toast("Meal saved");
}

function renderSaved(){
  const out = document.getElementById("savedOut");
  const meals = loadMeals();
  if(!meals.length){
    out.innerHTML = `<div class="muted">No saved meals yet. Generate one and hit “Save Meal”.</div>`;
    return;
  }
  out.innerHTML = meals.map(m=>{
    const meal = m.meal;
    return `
      <div class="result">
        <div style="font-weight:900">${esc(m.name)} <span class="pill blue">${new Date(m.ts).toLocaleString()}</span></div>
        <div class="mini">
          <b>Protein:</b> ${esc(meal.picked.protein||"—")} • <b>Carb:</b> ${esc(meal.picked.carb||"—")} • <b>Veg:</b> ${esc(meal.picked.veg||"—")}
        </div>
        <details style="margin-top:10px;">
          <summary>Grocery list</summary>
          <pre style="white-space:pre-wrap;margin:10px 0 0;color:var(--muted);font-size:12.5px;line-height:1.35">${esc(groceryText(meal))}</pre>
          <button class="btn secondary" style="margin-top:10px;" onclick='copySaved("${m.id}")'>Copy grocery list</button>
        </details>
        <details style="margin-top:10px;">
          <summary>Cooking instructions</summary>
          <ul class="list">${meal.instructions.map(s=>`<li>${esc(s)}</li>`).join("")}</ul>
        </details>
        <div class="divider"></div>
        <button class="btn danger" onclick='deleteSaved("${m.id}")'>Delete</button>
      </div>
    `;
  }).join("");
}

function copySaved(id){
  const meals = loadMeals();
  const m = meals.find(x=>x.id===id);
  if(!m) return;
  exportGrocery(m.meal);
}

function deleteSaved(id){
  const meals = loadMeals().filter(x=>x.id!==id);
  saveMeals(meals);
  renderSaved();
  toast("Deleted");
}

/* -------------------------------------------
   12) Wire up tabs + buttons
   ------------------------------------------- */

let CURRENT_MEAL = null;

function showTab(id){
  for(const sec of ["scanner","planner","directory","saved","history"]){
    const el = document.getElementById(sec);
    if(!el) continue;
    el.classList.toggle("hidden", sec!==id);
  }
  document.querySelectorAll(".tabbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab===id);
  });
}

document.querySelectorAll(".tabbtn").forEach(b=>{
  b.addEventListener("click", ()=>showTab(b.dataset.tab));
});

document.getElementById("scanBtn").addEventListener("click", ()=>{
  const raw = document.getElementById("scanInput").value || "";
  const results = runScan(raw);
  renderScan(results);
  if(results.length){
    addHistory(raw, results);
    toast("Scan complete");
  }else{
    toast("Nothing to scan");
  }
});

document.getElementById("demoBtn").addEventListener("click", ()=>{
  document.getElementById("scanInput").value =
`Ingredients: Chicken, brown rice, green bell peppers, calcium carbonate (to maintain freshness), rosemary extract, E221 sodium sulphite, pumpkin puree, bone broth`;
  toast("Demo loaded");
});

document.getElementById("clearScanBtn").addEventListener("click", ()=>{
  document.getElementById("scanInput").value = "";
  document.getElementById("scanResults").innerHTML = "";
  toast("Cleared");
});

document.getElementById("genMealBtn").addEventListener("click", ()=>{
  CURRENT_MEAL = buildMeal();
  renderMeal(CURRENT_MEAL);
  renderGrocery(CURRENT_MEAL);
  toast("Meal generated");
});

document.getElementById("saveMealBtn").addEventListener("click", ()=>{
  if(!CURRENT_MEAL){ toast("Generate a meal first"); return; }
  saveMeal(CURRENT_MEAL);
});

document.getElementById("exportGroceryBtn").addEventListener("click", ()=>{
  if(!CURRENT_MEAL){ toast("Generate a meal first"); return; }
  exportGrocery(CURRENT_MEAL);
});

["togProtein","togCarb","togVeg","togFat","togFlavor","togLiquid"].forEach(id=>{
  document.getElementById(id).addEventListener("change", ()=>{
    renderGrocery(CURRENT_MEAL);
  });
});

document.getElementById("dirSearch").addEventListener("input", (e)=>{
  renderDirectory(e.target.value);
});

document.getElementById("clearSavedBtn").addEventListener("click", ()=>{
  if(confirm("Clear ALL saved meals?")){ saveMeals([]); renderSaved(); toast("Cleared saved meals"); }
});

document.getElementById("clearHistBtn").addEventListener("click", ()=>{
  if(confirm("Clear scan history?")){ saveHistory([]); renderHistory(); toast("Cleared history"); }
});

// initial renders
renderDirectory("");
renderSaved();
renderHistory();
renderScan([]);

</script>
</body>
  </html>
