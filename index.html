<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Coco & Ollie ‚Äî Allergy Scanner + Meal Planner</title>

<style>
  :root{
    --bg:#0b1424;
    --panel:#121f35;
    --panel2:#0f1b2f;
    --ink:#eaf1ff;
    --muted:rgba(234,241,255,.78);
    --muted2:rgba(234,241,255,.60);
    --line:rgba(255,255,255,.08);

    --blue:#2f6df6;
    --purple:#8a5cff;

    --good:#5cffad;
    --bad:#ff6b6b;
    --caution:#ffd166;

    --shadow:0 16px 44px rgba(0,0,0,.34);
    --radius:18px;
    --radius2:14px;
    --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  }

  *{box-sizing:border-box}
  body{
    margin:0; padding:18px;
    background: radial-gradient(1200px 800px at 20% 0%, rgba(47,109,246,.18), transparent 55%),
                radial-gradient(1200px 800px at 80% 10%, rgba(138,92,255,.14), transparent 55%),
                var(--bg);
    color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .wrap{max-width:980px; margin:0 auto}
  .hero{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    margin:10px 0 14px;
    padding:14px 14px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .hero h1{
    font-size:18px; margin:0;
    letter-spacing:.2px;
  }
  .hero .sub{
    font-size:13px; color:var(--muted);
    margin-top:3px;
  }
  .badgeRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .badge{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--muted);
    white-space:nowrap;
  }

  .tabs{
    display:flex; gap:10px; flex-wrap:wrap;
    justify-content:center;
    margin: 14px 0 18px;
  }
  .tabBtn{
    border:none;
    cursor:pointer;
    padding:11px 14px;
    border-radius:999px;
    font-weight:800;
    color:var(--ink);
    background: rgba(255,255,255,.05);
    border:1px solid var(--line);
    transition: transform .08s ease, background .2s ease;
  }
  .tabBtn:active{transform:scale(.98)}
  .tabBtn.active{
    background: linear-gradient(180deg, rgba(47,109,246,.45), rgba(47,109,246,.22));
    border-color: rgba(47,109,246,.45);
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius: var(--radius);
    padding:16px;
    box-shadow: var(--shadow);
    margin-bottom:16px;
  }
  .card h2{
    margin:0 0 10px;
    font-size:16px;
    letter-spacing:.2px;
  }
  .muted{color:var(--muted); font-size:13px; line-height:1.45}
  .muted2{color:var(--muted2); font-size:12px; line-height:1.45}
  .divider{height:1px; background:var(--line); margin:12px 0}

  .grid2{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media (max-width:820px){ .grid2{grid-template-columns:1fr} }

  textarea, input, select{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(10,18,32,.65);
    color:var(--ink);
    outline:none;
    font-size:16px;
  }
  textarea{min-height:122px; resize:vertical}
  label{display:block; font-size:12px; color:var(--muted); font-weight:800; margin:10px 0 6px}

  .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .btn{
    border:none; cursor:pointer;
    padding:11px 14px;
    border-radius:14px;
    font-weight:900;
    color:var(--ink);
    background: rgba(255,255,255,.06);
    border:1px solid var(--line);
  }
  .btn.primary{
    background: linear-gradient(180deg, rgba(47,109,246,.55), rgba(47,109,246,.25));
    border-color: rgba(47,109,246,.45);
  }
  .btn.purple{
    background: linear-gradient(180deg, rgba(138,92,255,.50), rgba(138,92,255,.22));
    border-color: rgba(138,92,255,.40);
  }
  .btn.good{
    background: linear-gradient(180deg, rgba(92,255,173,.22), rgba(92,255,173,.12));
    border-color: rgba(92,255,173,.30);
  }
  .btn.danger{
    background: linear-gradient(180deg, rgba(255,107,107,.24), rgba(255,107,107,.12));
    border-color: rgba(255,107,107,.30);
  }

  .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .pill{
    display:inline-flex; gap:7px; align-items:center;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:var(--muted);
  }
  .pill.good{color:var(--good); border-color: rgba(92,255,173,.28); background: rgba(92,255,173,.08)}
  .pill.bad{color:var(--bad); border-color: rgba(255,107,107,.28); background: rgba(255,107,107,.08)}
  .pill.caution{color:var(--caution); border-color: rgba(255,209,102,.28); background: rgba(255,209,102,.08)}
  .tag{
    font-size:11px;
    font-weight:950;
    padding:4px 9px;
    border-radius:999px;
    display:inline-block;
    margin-left:8px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.05);
    color:var(--muted);
  }
  .tag.food{border-color: rgba(47,109,246,.4); background: rgba(47,109,246,.14); color:#cfe0ff}
  .tag.add{border-color: rgba(138,92,255,.4); background: rgba(138,92,255,.14); color:#e3d7ff}

  .result{
    margin-top:12px;
    padding:12px;
    border-radius: var(--radius2);
    border:1px solid var(--line);
    background: rgba(8,14,26,.60);
  }
  .result .title{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    font-weight:950;
    letter-spacing:.2px;
  }
  .result .title .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .result .reason{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.45}
  .result.good{border-color: rgba(92,255,173,.22)}
  .result.bad{border-color: rgba(255,107,107,.22)}
  .result.caution{border-color: rgba(255,209,102,.20)}
  .mono{font-family:var(--mono)}
  details{
    margin-top:10px;
    border-radius: var(--radius2);
    border:1px solid var(--line);
    background: rgba(8,14,26,.55);
    padding:10px 12px;
  }
  summary{cursor:pointer; font-weight:950; color:var(--ink)}
  .mini{font-size:12px; color:var(--muted2); line-height:1.5; margin-top:8px}
  .kicker{
    font-size:12px; color:var(--muted);
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }

  .savedCard{
    border:1px solid var(--line);
    background: rgba(8,14,26,.55);
    border-radius: var(--radius);
    padding:12px;
    margin-top:12px;
  }
  .savedCard h3{margin:0 0 6px; font-size:14px}
  .savedMeta{font-size:12px; color:var(--muted); margin-bottom:10px}
  .savedBox{
    border:1px solid var(--line);
    border-radius: var(--radius2);
    background: rgba(255,255,255,.03);
    padding:10px;
    margin-top:10px;
  }
  .savedBox .mono{white-space:pre-wrap}
</style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <div>
      <h1>üêæ Coco & Ollie ‚Äî Scanner + Meal Planner</h1>
      <div class="sub">Food + Additives in one scan ‚Ä¢ Smart matching ‚Ä¢ Grocery + cooking ‚Ä¢ Save meals</div>
    </div>
    <div class="badgeRow">
      <span class="badge">‚úÖ Smart plurals</span>
      <span class="badge">‚úÖ OCR parentheses</span>
      <span class="badge">‚úÖ Variant caution</span>
      <span class="badge">‚úÖ US units</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" id="tab-scanner" onclick="showTab('scanner')">Scanner</button>
    <button class="tabBtn" id="tab-meal" onclick="showTab('meal')">Meal Planner</button>
    <button class="tabBtn" id="tab-saved" onclick="showTab('saved')">Saved Meals</button>
    <button class="tabBtn" id="tab-lists" onclick="showTab('lists')">Lists</button>
  </div>

  <!-- SCANNER -->
  <div id="scanner" class="card">
    <h2>üîç Scanner</h2>
    <div class="muted">
      Paste ingredients (comma or line separated). This scans <b>Food + Additives</b> at the same time, fixes plurals, ignores OCR parenthesis notes, and explains <b>why</b> something is flagged.
    </div>

    <label>Ingredients to scan</label>
    <textarea id="scanInput" placeholder="Example:
Ingredients: apples, calcium ascorbate, ascorbic acid, calcium carbonate (to maintain freshness and color)
Chicken, beef, yogurt, carrots, rice flour, coconut oil, E 221 sodium sulphite"></textarea>

    <div class="btnRow">
      <button class="btn primary" onclick="scanAll()">Scan</button>
      <button class="btn" onclick="demoScan()">Demo</button>
      <button class="btn" onclick="clearScan()">Clear</button>
    </div>

    <div id="scanResults"></div>

    <details>
      <summary>üì∏ Photo ‚Üí Text tips (iPhone / AI)</summary>
      <div class="mini">
        <b>iPhone:</b> take a photo ‚Üí open it ‚Üí tap the Live Text icon ‚Üí select ingredients ‚Üí copy ‚Üí paste here.<br><br>
        <b>Parenthesis notes:</b> this app ignores them for matching. Example:
        <span class="mono">calcium carbonate (to maintain freshness)</span> still matches <span class="mono">calcium carbonate</span>.<br><br>
        <b>Plural-proof:</b> <span class="mono">carrots</span> matches <span class="mono">carrot</span>. <span class="mono">noodles</span> matches <span class="mono">noodles - wheat</span> only if it truly matches a flagged item.
      </div>
    </details>
  </div>

  <!-- MEAL PLANNER -->
  <div id="meal" class="card" style="display:none">
    <h2>üç≤ Meal Planner</h2>
    <div class="muted">
      Generates meals from an expanded library of dog-edible foods + flavors, then <b>filters out anything Moderate/High</b> for either dog. US units only: <b>lbs / oz / cups / fl oz</b>.
    </div>

    <div class="grid2">
      <div>
        <label>Coco weight (lbs)</label>
        <input id="cocoWeight" type="number" value="55" min="1" step="1" />
      </div>
      <div>
        <label>Ollie weight (lbs)</label>
        <input id="ollieWeight" type="number" value="65" min="1" step="1" />
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Activity level</label>
        <select id="activity">
          <option value="sedentary">Sedentary / weight loss</option>
          <option value="normal" selected>Normal</option>
          <option value="active">Active</option>
          <option value="very_active">Very active</option>
          <option value="working">Working / high output</option>
        </select>
        <div class="muted2" id="activityHint"></div>
      </div>

      <div>
        <label>Meals per day</label>
        <select id="mealsPerDay">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
        </select>
      </div>
    </div>

    <label>Batch days (1‚Äì7)</label>
    <input id="batchDays" type="range" min="1" max="7" value="7" />
    <div class="kicker"><span class="badge" id="batchLabel">7 days</span><span class="muted2">Used for grocery totals + batch cook math</span></div>

    <div class="grid2">
      <div>
        <label>Liquid display</label>
        <select id="liquidUnit">
          <option value="fl_oz" selected>fl oz (US)</option>
          <option value="cups">cups</option>
        </select>
      </div>
      <div>
        <label>Flavor intensity</label>
        <select id="flavorIntensity">
          <option value="light">Light</option>
          <option value="normal" selected>Normal</option>
          <option value="extra">Extra tasty</option>
        </select>
      </div>
    </div>

    <div class="btnRow">
      <button class="btn primary" onclick="generateMeal()">Generate Meal</button>
      <button class="btn purple" onclick="saveMeal()">Save Meal Snapshot</button>
      <button class="btn" onclick="copyLastGrocery()">Copy Grocery</button>
      <button class="btn" onclick="exportLastGrocery()">Export Grocery</button>
    </div>

    <div id="mealOutput"></div>

    <details>
      <summary>üß† Notes (so this doesn‚Äôt bite you later)</summary>
      <div class="mini">
        ‚Ä¢ This is a planning + shopping tool. If symptoms are serious, do elimination diet guidance with your vet.<br>
        ‚Ä¢ ‚ÄúSafe‚Äù here means ‚Äúnot listed as Moderate/High in your test lists.‚Äù<br>
        ‚Ä¢ Always avoid onion/garlic seasoning. Keep broth plain.
      </div>
    </details>
  </div>

  <!-- SAVED -->
  <div id="saved" class="card" style="display:none">
    <h2>üíæ Saved Meals</h2>
    <div class="muted">Saved meals are stored on this device (localStorage). Each save is a snapshot: meal + feeding + grocery + instructions.</div>
    <div id="savedMeals"></div>
  </div>

  <!-- LISTS -->
  <div id="lists" class="card" style="display:none">
    <h2>üìö Lists</h2>
    <div class="muted">High + Moderate lists used by the scanner. (No search here ‚Äî just clean, collapsible reference.)</div>

    <details open>
      <summary>üçñ Food ‚Äî Coco</summary>
      <div class="mini" id="listFoodCoco"></div>
    </details>

    <details>
      <summary>üçñ Food ‚Äî Ollie</summary>
      <div class="mini" id="listFoodOllie"></div>
    </details>

    <details>
      <summary>üß™ Additives ‚Äî Coco</summary>
      <div class="mini" id="listAddCoco"></div>
    </details>

    <details>
      <summary>üß™ Additives ‚Äî Ollie</summary>
      <div class="mini" id="listAddOllie"></div>
    </details>

    <details>
      <summary>üß∑ Combined (Coco + Ollie) ‚Äî Food + Additives</summary>
      <div class="mini" id="listCombined"></div>
    </details>
  </div>
</div>

<script>
/* =========================================================
   1) DATA ‚Äî COCO & OLLIE (High + Moderate) + Additives
   ========================================================= */

const DATA = {
  food:{
    coco:{
      high:[
        "Canola Oil","Chia Seeds","Clove","Haddock","Herring","Mozzarella","Paprika","Peach",
        "Rabbit","Rabbit Heart","Rabbit Liver","Rapeseed oil","Sugar (brown)","Sweet Potato","Tahini"
      ],
      moderate:[
        "Ammonium Laureth Sulfate","Beef","Bilberry","Cheese - Cheddar","Chlorella","Coconut","Cornflakes",
        "Egg Yolk - Chicken","Egg Yolk - Duck","Hare","Iceberg lettuce","Lemon","Pecan nut","Pepper - green",
        "Psyllium Seed Husk","Strawberry","Turnip","Winkles"
      ]
    },
    ollie:{
      high:[
        "Avocado oil","Boar","Buttermilk","Canola Meal","Coconut","Coconut Oil","Crab","Duck Liver",
        "Noodles - wheat","Papaya","Parmesan","Prawn","Sage","Strawberry","Tapioca","Venison Meal"
      ],
      moderate:[
        "Anchovy","Catfish","Cheese - Cottage","Chicken Heart","Condensed milk","Cream","Egg White - Chicken",
        "Emmer wheat","Farina secalis cerealis","Ginkgo biloba","Greens (Collard)","Lamb Liver","Liver - ox",
        "Milkweed","Onion","Pepper - green","Pheasant Gizzard","Pigeon","Raisin","Skate","Soy Flour",
        "Sweet Potato","Tilefish","Winkles"
      ]
    }
  },

  additives:{
    coco:{
      high:[
        "E 110 Sunset Yellow (orange synthetic dye)",
        "E 160 b Annatto (yellow to orange coloring)",
        "E 180 Lithol Rubine BK (red synthetic dye)",
        "E 221 Sodium sulphite (preservative)",
        "E 332 Potassium citrate (acidity regulator)",
        "E 483 Stearyl tartrate (emulsifier)",
        "E 576 Sodium gluconate (acidity regulator)",
        "E 620 Glutamic acid (flavour enhancer)",
        "E 959 Neohesperidine DC (sweetener)",
        "Rose (Rosa spp.)"
      ],
      moderate:[
        "Artichoke leaf extract",
        "E 200 Sorbic acid (preservative)",
        "E 233 Thiabendazole (preservative/fungicide)",
        "E 312 Dodecyl gallate (antioxidant)",
        "E 340 Potassium phosphate (emulsifier)",
        "E 411 Xantham gum (thickener)",
        "E 528 Magnesium hydroxide (acidity regulator)",
        "E 535 Sodium ferrocyanide (anti-caking agent)",
        "E 624 Monoammonium glutamate (flavour enhancer)",
        "E 629 Calcium guanylate (flavour enhancer)",
        "E 630 Inosinic acid (flavour enhancer)",
        "E 927 Azodicarbonamide (flour treatment agent)",
        "Rosemary Extract"
      ]
    },
    ollie:{
      high:[
        "E 141 Copper complexes of chlorophyll (green coloring)",
        "E 150 d Sulphite Ammonia Caramel (brown coloring)",
        "E 160 e Beta-apo-8'-carotenal (orange pigment)",
        "E 162 Beetroot red (natural red coloring)",
        "E 218 Methyl p-hydroxybenzoate (preservative)",
        "E 242 Dimethyl dicarbonate (sterilizing agent)",
        "E 260 Acetic acid (preservative)",
        "E 263 Calcium acetate (acidity regulator)",
        "E 270 Lactic acid (preservative)",
        "E 335 Sodium tartrate (acidity regulator)",
        "E 472 d Tartaric acid esters of mono- and diglycerides (emulsifier)",
        "E 473 Sucrose esters of fatty acids (emulsifier)",
        "E 477 Propylene glycol esters of fatty acids (emulsifier)",
        "E 522 Aluminium potassium sulphate (stabiliser)",
        "E 541 Sodium aluminium phosphate (raising agent)",
        "E 630 Inosinic acid (flavour enhancer)",
        "E 941 Nitrogen (packing gas)",
        "E 951 Aspartame (sweetener)",
        "Formic acid",
        "Pepsin",
        "Tartaric acid"
      ],
      moderate:[
        "E 150 c Ammonia Caramel (brown coloring)",
        "E 1520 Propylene glycol",
        "E 249 Potassium nitrite (curing agent)",
        "E 284 Boric acid (preservative)",
        "E 312 Dodecyl gallate (antioxidant)",
        "E 334 Tartaric acid (acidity regulator)",
        "E 353 Metatartaric acid (acidity regulator)",
        "E 354 Calcium tartrate (acidity regulator)",
        "E 472 e Mono- and diacetyltartaric acid esters of mono- and diglycerides (emulsifier)",
        "E 476 Polyglycerol polyricinoleate (emulsifier)",
        "E 554 Sodium aluminosilicate (anti-caking agent)",
        "E 621 Monosodium glutamate (flavour enhancer)",
        "E 634 Calcium 5'-ribonucleotides (flavour enhancer)",
        "E 902 Candelilla wax (coating agent)",
        "E 903 Carnauba wax (coating agent)",
        "Formalin"
      ]
    }
  }
};

/* =========================================================
   2) SMART MATCHING ENGINE
   - fixes plurals: carrots -> carrot
   - ignores OCR parentheses: "x (to maintain...)" -> "x"
   - understands parent keywords (rice/yogurt/etc.)
   - separates ‚Äúrice‚Äù vs ‚Äúrice flour‚Äù correctly
   ========================================================= */

// Parent keyword groups for CAUTION breakdown
const PARENTS = {
  rice: ["Rice (brown)","Rice (white)","Rice Bran","Rice Flour","Rice milk"],
  yogurt: ["Yogurt (plain)"],
  coconut: ["Coconut","Coconut Oil","Coconut milk","Coconut water"],
  pepper: ["Pepper - green","Pepper - red","Pepper - white","Pepper - black"],
  egg: ["Egg White - Chicken","Egg Yolk - Chicken","Egg White - Duck","Egg Yolk - Duck"]
};

// quick aliases (common label variants)
const ALIASES = {
  "brown rice":"Rice (brown)",
  "white rice":"Rice (white)",
  "rice flour":"Rice Flour",
  "rice bran":"Rice Bran",
  "rice milk":"Rice milk",
  "yogurt":"Yogurt (plain)", // for matching intent; still shown as CAUTION per your ‚ÄúB‚Äù
  "yoghurt":"Yogurt (plain)",
  "coconut oil":"Coconut Oil",
  "bone broth":"Bone broth",
  "broth":"Bone broth"
};

function norm(s){
  return (s||"")
    .replace(/\u2019/g,"'")            // curly apostrophes
    .toLowerCase()
    .replace(/ingredients\s*:\s*/ig,"")
    .replace(/\([^)]*\)/g," ")         // drop parenthesis notes (OCR)
    .replace(/[^a-z0-9\s\-]/g," ")     // keep letters/numbers/space/dash
    .replace(/\s+/g," ")
    .trim();
}

// singularize basic plural (carrots -> carrot, berries -> berry)
function singularizeWord(w){
  if(w.endsWith("ies") && w.length>4) return w.slice(0,-3)+"y";
  if(w.endsWith("ses") && w.length>4) return w.slice(0,-2);
  if(w.endsWith("s") && !w.endsWith("ss") && w.length>3) return w.slice(0,-1);
  return w;
}

function keyify(s){
  const t = norm(s)
    .replace(/\-/g," ")          // treat dash as space for matching
    .replace(/\s+/g," ")
    .trim();
  const parts = t.split(" ").filter(Boolean).map(singularizeWord);
  return parts.join(" ");
}

function tokenize(s){
  return keyify(s).split(" ").filter(Boolean);
}

function buildCandidateKeys(raw){
  const base = keyify(raw);
  const parts = tokenize(raw);

  // Also make a ‚Äúhead‚Äù keyword for parent logic
  const head = parts[0] || "";

  // Some OCR lists come as "calcium carbonate to maintain freshness"
  // We already drop parentheses; still keep base.
  const set = new Set();
  if(base) set.add(base);

  // Alias pass
  const aliasKey = ALIASES[base];
  if(aliasKey) set.add(keyify(aliasKey));

  // If user typed ‚Äúyogurt plain‚Äù or ‚Äúplain yogurt‚Äù
  if(base.includes("yogurt")) set.add(keyify("Yogurt (plain)"));

  // If user typed ‚Äúrice‚Äù alone, keep base as ‚Äúrice‚Äù
  return { keys:[...set], head };
}

// Determine if input is a specific rice variant (don‚Äôt explode into parent group)
function isSpecificRice(inputKey){
  return inputKey.includes("rice") && (
    inputKey.includes("flour") || inputKey.includes("bran") || inputKey.includes("milk")
  );
}

function shouldExpandParent(raw){
  const k = keyify(raw);
  const toks = tokenize(raw);
  const head = toks[0] || "";

  if(!PARENTS[head]) return false;

  // Special case: rice flour/bran/milk should NOT expand
  if(head==="rice" && isSpecificRice(k)) return false;

  // Expand only when user typed a generic keyword (one word)
  return toks.length === 1;
}

// Build lookup maps for speed
function makeLookup(items){
  const map = new Map();
  for(const raw of items){
    map.set(keyify(raw), raw);
  }
  return map;
}

const LOOK = {
  food:{
    coco:{ high: makeLookup(DATA.food.coco.high), moderate: makeLookup(DATA.food.coco.moderate) },
    ollie:{ high: makeLookup(DATA.food.ollie.high), moderate: makeLookup(DATA.food.ollie.moderate) }
  },
  additives:{
    coco:{ high: makeLookup(DATA.additives.coco.high), moderate: makeLookup(DATA.additives.coco.moderate) },
    ollie:{ high: makeLookup(DATA.additives.ollie.high), moderate: makeLookup(DATA.additives.ollie.moderate) }
  }
};

// A term can match BOTH food and additive (rare), so we return multiple hits.
function findReactivityHits(rawTerm){
  const {keys} = buildCandidateKeys(rawTerm);

  const hits = []; // each: {type, dog, sev, canonical, matchKey}
  for(const type of ["food","additives"]){
    for(const dog of ["coco","ollie"]){
      for(const sev of ["high","moderate"]){
        const map = LOOK[type][dog][sev];
        for(const k of keys){
          if(map.has(k)){
            hits.push({
              type, dog, sev: (sev==="high"?"High":"Moderate"),
              canonical: map.get(k),
              matchKey: k
            });
          }
        }
      }
    }
  }

  // If nothing matched exactly, do a contained-keyword fallback
  // Example: "carrot puree" should match "carrot"
  if(hits.length===0){
    const inputKey = keyify(rawTerm);

    // We only do contained matching for FOOD (not additives), to avoid false positives with E numbers.
    for(const dog of ["coco","ollie"]){
      // Search through that dog‚Äôs high/mod lists to see if any canonical key is contained as a whole word sequence.
      const all = [
        ...DATA.food[dog].high.map(x=>({sev:"High", canonical:x, k:keyify(x)})),
        ...DATA.food[dog].moderate.map(x=>({sev:"Moderate", canonical:x, k:keyify(x)}))
      ];

      for(const entry of all){
        if(containsWholePhrase(inputKey, entry.k)){
          hits.push({type:"food", dog, sev:entry.sev, canonical:entry.canonical, matchKey: entry.k, contained:true});
        }
      }
    }

    // Additives contained fallback: only if user input includes "e" or looks like additive text
    // (prevents ‚Äúsalt‚Äù from matching random additive names)
    const looksAdditive = /\be\s*\d+\b/.test(norm(rawTerm)) || keyify(rawTerm).startsWith("e");
    if(looksAdditive){
      const input = norm(rawTerm);
      for(const dog of ["coco","ollie"]){
        const all = [
          ...DATA.additives[dog].high.map(x=>({sev:"High", canonical:x, k: keyify(x)})),
          ...DATA.additives[dog].moderate.map(x=>({sev:"Moderate", canonical:x, k:keyify(x)}))
        ];
        for(const entry of all){
          // check for E-number match
          const eNum = entry.canonical.match(/\bE\s*\d+\b/i);
          if(eNum){
            const eKey = eNum[0].toLowerCase().replace(/\s+/g,""); // e221
            const inKey = input.toLowerCase().replace(/\s+/g,"");
            if(inKey.includes(eKey)){
              hits.push({type:"additives", dog, sev:entry.sev, canonical:entry.canonical, matchKey: entry.k, contained:true});
            }
          }
        }
      }
    }
  }

  // Deduplicate exact same hit
  const seen = new Set();
  return hits.filter(h=>{
    const id = `${h.type}|${h.dog}|${h.sev}|${keyify(h.canonical)}`;
    if(seen.has(id)) return false;
    seen.add(id);
    return true;
  });
}

// true if phrase is contained as whole words in order
function containsWholePhrase(hayKey, needleKey){
  // needleKey like "pepper green" must match whole words order
  const hay = ` ${hayKey} `;
  const needle = ` ${needleKey} `;
  return hay.includes(needle);
}

/* =========================================================
   3) SCANNER: parse input, classify, render results
   ========================================================= */

function parseInput(raw){
  const s = (raw||"").replace(/\r/g,"");
  // split on newlines, commas, semicolons
  return s
    .replace(/ingredients\s*:\s*/ig,"")
    .split(/[\n,;]+/)
    .map(x=>x.trim())
    .filter(Boolean);
}

function classifyType(rawTerm){
  // If it looks like an E-number, treat as additive; otherwise treat as food.
  // NOTE: we STILL scan both datasets; this is only the tag shown.
  const t = norm(rawTerm);
  if(/\be\s*\d+\b/.test(t) || t.startsWith("e ")) return "additives";
  return "food";
}

function renderScanResult(item){
  // Parent expansion: rice/yogurt/etc (generic keyword)
  if(shouldExpandParent(item)){
    return renderParentCaution(item);
  }

  const typeTag = classifyType(item);
  const hits = findReactivityHits(item);

  // If no hits, still might deserve CAUTION if it contains a parent keyword but not specific
  // Example: ‚Äúrice crackers‚Äù should show CAUTION, because "rice" generic keyword appears
  const inputKey = keyify(item);
  const parentContained = Object.keys(PARENTS).find(p=>{
    if(p==="rice" && isSpecificRice(inputKey)) return false;
    return containsWholePhrase(inputKey, p);
  });

  if(hits.length===0 && parentContained){
    // CAUTION: contains parent keyword, show breakdown
    return renderParentCaution(parentContained, {displayAs:item, reasonOverride:`Contains keyword ‚Äú${parentContained}‚Äù. Showing known variants.`});
  }

  if(hits.length===0){
    return `
      <div class="result good">
        <div class="title">
          <div class="left">
            ‚úÖ <span>${esc(item)}</span>
            <span class="tag ${typeTag==="food"?"food":"add"}">${typeTag==="food"?"Food":"Additive"}</span>
          </div>
          <span class="pill good">SAFE</span>
        </div>
        <div class="reason">
          No listed Moderate/High reactivity found for Coco or Ollie.
        </div>
        <div class="pillRow">
          <span class="pill good">Coco: OK</span>
          <span class="pill good">Ollie: OK</span>
        </div>
      </div>
    `;
  }

  // Build per-dog summaries, and ‚Äúwhy‚Äù
  const byDog = {coco:[], ollie:[]};
  for(const h of hits) byDog[h.dog].push(h);

  const cocoWorst = worstSeverity(byDog.coco);
  const ollieWorst = worstSeverity(byDog.ollie);

  const isBad = cocoWorst || ollieWorst;
  const tagClass = typeTag==="food"?"food":"add";

  const why = buildWhyText(item, hits);

  return `
    <div class="result bad">
      <div class="title">
        <div class="left">
          ‚ö†Ô∏è <span>${esc(item)}</span>
          <span class="tag ${tagClass}">${typeTag==="food"?"Food":"Additive"}</span>
        </div>
        <span class="pill bad">NOT SAFE</span>
      </div>
      <div class="reason">${why}</div>
      <div class="pillRow">
        ${renderDogPill("Coco", cocoWorst, byDog.coco)}
        ${renderDogPill("Ollie", ollieWorst, byDog.ollie)}
      </div>
    </div>
  `;
}

function worstSeverity(hits){
  // High beats Moderate
  if(!hits || hits.length===0) return null;
  if(hits.some(h=>h.sev==="High")) return "High";
  return "Moderate";
}

function renderDogPill(name, worst, hits){
  if(!worst) return `<span class="pill good">${name}: OK</span>`;
  const cls = worst==="High" ? "bad" : "caution";
  const details = hits.map(h=>{
    const t = h.type==="food" ? "Food" : "Additive";
    return `${t}: ${h.sev} (${h.canonical})`;
  });
  const text = `${name}: ${worst}`;
  return `<span class="pill ${cls}" title="${esc(details.join(" | "))}">${text}</span>`;
}

function buildWhyText(item, hits){
  // Prefer showing the canonical matches and if it was contained-match
  const parts = [];
  const show = hits.slice(0,4).map(h=>{
    const t = h.type==="food" ? "Food" : "Additive";
    const how = h.contained ? "matched inside" : "matched";
    return `${t} ${how}: ‚Äú${h.canonical}‚Äù ‚Üí ${h.dog==="coco"?"Coco":"Ollie"} (${h.sev})`;
  });
  parts.push(show.join(" ¬∑ "));

  // If more hits exist, mention
  if(hits.length>4) parts.push(`(+${hits.length-4} more matches)`);

  // Extra hint for yogurt behavior B
  const k = keyify(item);
  if(k==="yogurt" || k.includes("yogurt")){
    parts.push(`Note: You typed ‚Äúyogurt‚Äù. Only ‚ÄúYogurt (plain)‚Äù is represented in the test lists ‚Äî other yogurt types aren‚Äôt tested here.`);
  }

  return esc(parts.join(" "));
}

// Parent caution renderer (Option B style)
function renderParentCaution(raw, opts={}){
  const display = opts.displayAs || raw;
  const parentKey = typeof raw === "string" ? raw : keyify(raw);
  const p = (typeof raw === "string" ? keyify(raw) : parentKey);

  // determine variants list
  const variants = PARENTS[p] || PARENTS[parentKey] || [];
  let rows = "";
  let anyFlag = false;

  for(const v of variants){
    const hits = findReactivityHits(v);
    const cWorst = worstSeverity(hits.filter(h=>h.dog==="coco" && h.type==="food"));
    const oWorst = worstSeverity(hits.filter(h=>h.dog==="ollie" && h.type==="food"));

    // For parent breakdown, prioritize FOOD for those variants.
    // (But still show if additive somehow matches.)
    const cTxt = cWorst ? `${cWorst}` : "OK";
    const oTxt = oWorst ? `${oWorst}` : "OK";
    if(cWorst || oWorst) anyFlag = true;

    rows += `
      <div class="muted" style="margin-top:8px; line-height:1.4">
        <b>${esc(v)}</b> ‚Äî
        <span style="color:${cWorst==="High"?"var(--bad)":cWorst==="Moderate"?"var(--caution)":"var(--good)"}">
          Coco: ${esc(cTxt)}
        </span>
        ¬∑
        <span style="color:${oWorst==="High"?"var(--bad)":oWorst==="Moderate"?"var(--caution)":"var(--good)"}">
          Ollie: ${esc(oTxt)}
        </span>
      </div>
    `;
  }

  let note = opts.reasonOverride || `Contains keyword ‚Äú${p}‚Äù. Showing known variants so you don‚Äôt get a false ‚ÄúOK‚Äù.`;
  if(p==="yogurt"){
    note = `You typed ‚Äúyogurt‚Äù. Only ‚ÄúYogurt (plain)‚Äù exists in the test lists. Other yogurt types aren‚Äôt tested here.`;
  }

  return `
    <div class="result caution">
      <div class="title">
        <div class="left">
          üü° <span>${esc(display)}</span>
          <span class="tag food">Food</span>
        </div>
        <span class="pill caution">CAUTION</span>
      </div>
      <div class="reason">${esc(note)}</div>
      <div class="pillRow">
        <span class="pill caution">Keyword: ${esc(p)}</span>
        ${anyFlag ? `<span class="pill caution">Some variants flagged</span>` : `<span class="pill good">No variants flagged</span>`}
      </div>
      <div class="divider"></div>
      ${rows || `<div class="muted2">No known variants configured for this keyword yet.</div>`}
    </div>
  `;
}

/* =========================================================
   4) SCANNER UI actions
   ========================================================= */

function scanAll(){
  const items = parseInput(document.getElementById("scanInput").value);
  if(items.length===0){
    document.getElementById("scanResults").innerHTML = `<div class="result"><div class="muted">Paste ingredients first.</div></div>`;
    return;
  }
  let html = "";
  for(const item of items){
    html += renderScanResult(item);
  }
  document.getElementById("scanResults").innerHTML = html;
}

function demoScan(){
  document.getElementById("scanInput").value =
`Ingredients: apples, calcium ascorbate, ascorbic acid, calcium carbonate (to maintain freshness and color)
Chicken
Beef
Yogurt
Carrots
Rice
Rice flour
Coconut oil
E 221 sodium sulphite`;
  scanAll();
}
function clearScan(){
  document.getElementById("scanInput").value = "";
  document.getElementById("scanResults").innerHTML = "";
}

/* =========================================================
   5) MEAL PLANNER
   - Expanded dog-edible library + flavor boosters
   - Filter out anything Moderate/High for either dog
   - US units only
   - Grocery list breakdown + export/copy
   - Save snapshot with everything
   ========================================================= */

// Activity -> planning percent of bodyweight/day (starting points)
const ACTIVITY_PCT = {
  sedentary: 2.0,
  normal: 2.5,
  active: 3.0,
  very_active: 3.5,
  working: 4.0
};

function updateActivityHint(){
  const v = document.getElementById("activity").value;
  const pct = ACTIVITY_PCT[v] || 2.5;
  document.getElementById("activityHint").innerText =
    `Planning rule: ~${pct.toFixed(1)}% of bodyweight/day (starting point). Adjust based on body condition + stools.`;
}
updateActivityHint();
document.getElementById("activity").addEventListener("change", updateActivityHint);

document.getElementById("batchDays").addEventListener("input", ()=>{
  document.getElementById("batchLabel").innerText = `${document.getElementById("batchDays").value} days`;
});

function lbsToOz(lbs){ return lbs * 16; }
function ozToCups(oz){ return oz / 4; } // rough household estimate
function fmtNumber(n, d=2){
  const s = (Math.round(n * Math.pow(10,d)) / Math.pow(10,d)).toString();
  return s;
}
function fmtLbsOz(totalOz){
  const lbs = Math.floor(totalOz / 16);
  const oz = totalOz - lbs*16;
  const ozTxt = fmtNumber(oz,1).replace(/\.0$/,"");
  if(lbs<=0) return `${ozTxt} oz`;
  return `${lbs} lb ${ozTxt} oz`;
}
function fmtCups(oz){
  const cups = ozToCups(oz);
  return `${fmtNumber(cups,2).replace(/0+$/,"").replace(/\.$/,"")} cups`;
}
function fmtLiquidFromOz(oz){
  // Treat broth/water-like: 1 oz weight ‚âà 1 fl oz
  const unit = document.getElementById("liquidUnit").value;
  if(unit==="cups") return fmtCups(oz*1.0);
  return `${fmtNumber(oz,1).replace(/\.0$/,"")} fl oz`;
}

// Expanded dog-edible library (we still filter against banned lists)
const LIB = {
  proteins: [
    "Chicken","Turkey","Duck","Lamb","Bison","Venison","Beef","Goat",
    "Sardine","Tuna","Cod","Trout","Salmon"
  ],
  carbs: [
    "Rice (brown)","Rice (white)","Quinoa","Oats","Barley",
    "Pumpkin","Butternut squash","Tapioca","Potato","Sweet Potato"
  ],
  veg: [
    "Zucchini","Green beans","Spinach","Broccoli","Peas","Cucumber","Carrot",
    "Cauliflower","Celery","Kale"
  ],
  fats: [
    "Fish Oil","Salmon Oil","Sunflower Oil","Olive Oil","Coconut Oil","Beef Fat"
  ],
  flavor: [
    "Pumpkin puree","Bone broth","Apple","Blueberries","Parsley",
    "Turmeric","Ginger","Honey"
  ]
};

// Filter out anything that is Moderate/High for either dog (FOOD only)
function isFoodBanned(name){
  const hits = findReactivityHits(name).filter(h=>h.type==="food");
  return hits.length>0;
}
function safePool(arr){
  return arr.filter(x => !isFoodBanned(x));
}
function pickRandom(arr){
  return arr[Math.floor(Math.random()*arr.length)];
}

let LAST_MEAL = null; // snapshot of latest generated meal

function generateMeal(){
  const cocoLbs = parseFloat(document.getElementById("cocoWeight").value || "0");
  const ollieLbs = parseFloat(document.getElementById("ollieWeight").value || "0");
  const mealsPerDay = parseInt(document.getElementById("mealsPerDay").value || "2", 10);
  const days = parseInt(document.getElementById("batchDays").value || "7", 10);
  const activity = document.getElementById("activity").value;
  const flavorIntensity = document.getElementById("flavorIntensity").value;

  if(!cocoLbs || !ollieLbs){
    document.getElementById("mealOutput").innerHTML = `<div class="result bad"><div class="muted">Enter both weights.</div></div>`;
    return;
  }

  // Calculate daily food amount via planning rule
  const pct = (ACTIVITY_PCT[activity] || 2.5) / 100;
  const cocoDailyOz = lbsToOz(cocoLbs * pct);
  const ollieDailyOz = lbsToOz(ollieLbs * pct);
  const totalDailyOz = cocoDailyOz + ollieDailyOz;
  const batchTotalOz = totalDailyOz * days;

  // Safe pools
  const proteins = safePool(LIB.proteins);
  const carbs = safePool(LIB.carbs);
  const veg = safePool(LIB.veg);
  const fats = safePool(LIB.fats);
  const flavors = safePool(LIB.flavor);

  // If filtering nukes something, tell user plainly
  if(proteins.length===0 || carbs.length===0 || veg.length===0){
    document.getElementById("mealOutput").innerHTML = `
      <div class="result bad">
        <div class="title"><div class="left">‚ùå Meal generation blocked</div><span class="pill bad">NO SAFE OPTIONS</span></div>
        <div class="reason">
          One or more categories has no safe items after filtering Moderate/High. (Your test lists are strict.)<br>
          You can still use the scanner to manually pick safe items.
        </div>
      </div>`;
    return;
  }

  // Choose meal components
  const protein = pickRandom(proteins);
  const carb = pickRandom(carbs);
  const veggie = pickRandom(veg);

  // Fat: optional (some fats might be filtered out). If none safe, fallback to Fish Oil (still gets filtered)
  const fat = fats.length ? pickRandom(fats) : "Fish Oil";

  // Flavor logic: pick 1-2 based on intensity
  const flavor1 = flavors.length ? pickRandom(flavors) : "Bone broth";
  let flavor2 = null;
  if(flavorIntensity==="extra" && flavors.length>1){
    // pick a different one
    for(let i=0;i<8;i++){
      const c = pickRandom(flavors);
      if(c!==flavor1){ flavor2=c; break; }
    }
  }

  // Macro split for batch total (simple + useful)
  // Protein 50% / Carb 20% / Veg 15% / Fat 5% / Flavor liquids/boost 10%
  const grams = {
    protein: batchTotalOz * 0.50,
    carb:    batchTotalOz * 0.20,
    veg:     batchTotalOz * 0.15,
    fat:     batchTotalOz * 0.05,
    boost:   batchTotalOz * 0.10
  };

  // If extra flavor, split boost into 2 parts
  const boostA = flavor2 ? grams.boost * 0.6 : grams.boost;
  const boostB = flavor2 ? grams.boost * 0.4 : 0;

  const cocoPerMealOz = cocoDailyOz / mealsPerDay;
  const olliePerMealOz = ollieDailyOz / mealsPerDay;

  const groceryText = buildGroceryText({
    days, mealsPerDay, activity,
    cocoDailyOz, ollieDailyOz, cocoPerMealOz, olliePerMealOz,
    batchTotalOz,
    protein, carb, veggie, fat,
    flavor1, flavor2,
    grams, boostA, boostB
  });

  const instructions = buildCookingInstructions({protein, carb, veggie, fat, flavor1, flavor2, days});

  LAST_MEAL = {
    id: cryptoId(),
    createdAt: new Date().toISOString(),
    meta: {days, mealsPerDay, activity, pct: ACTIVITY_PCT[activity] || 2.5},
    weights: {cocoLbs, ollieLbs},
    feeding: {cocoDailyOz, ollieDailyOz, cocoPerMealOz, olliePerMealOz, totalDailyOz, batchTotalOz},
    picks: {protein, carb, veggie, fat, flavor1, flavor2},
    grams, boostA, boostB,
    groceryText,
    instructions
  };

  document.getElementById("mealOutput").innerHTML = `
    <div class="divider"></div>
    <div class="result good">
      <div class="title">
        <div class="left">‚ú® Meal Suggestion</div>
        <span class="pill good">SAFE-ONLY FILTER</span>
      </div>
      <div class="reason">
        This meal was built from dog-edible options and then filtered to exclude anything Moderate/High for either dog.
      </div>

      <div class="pillRow">
        <span class="pill good">Protein: ${esc(protein)}</span>
        <span class="pill good">Carb: ${esc(carb)}</span>
        <span class="pill good">Veg: ${esc(veggie)}</span>
        <span class="pill good">Fat: ${esc(fat)}</span>
        <span class="pill good">Flavor: ${esc(flavor1)}${flavor2?` + ${esc(flavor2)}`:""}</span>
      </div>

      <div class="divider"></div>
      <div class="kicker">
        <span class="badge">Activity: ${esc(activityLabel(activity))}</span>
        <span class="badge">Rule: ${fmtNumber(LAST_MEAL.meta.pct,1)}% bodyweight/day</span>
        <span class="badge">Meals/day: ${mealsPerDay}</span>
        <span class="badge">Batch: ${days} day(s)</span>
      </div>

      <div class="divider"></div>
      <div class="muted"><b>Feeding amounts</b> (oz + cups)</div>
      <div class="muted2">
        Coco daily: <b>${fmtLbsOz(cocoDailyOz)}</b> (~${fmtCups(cocoDailyOz)}) ¬∑ per meal: <b>${fmtLbsOz(cocoPerMealOz)}</b> (~${fmtCups(cocoPerMealOz)})<br>
        Ollie daily: <b>${fmtLbsOz(ollieDailyOz)}</b> (~${fmtCups(ollieDailyOz)}) ¬∑ per meal: <b>${fmtLbsOz(olliePerMealOz)}</b> (~${fmtCups(olliePerMealOz)})<br>
        Batch total: <b>${fmtLbsOz(batchTotalOz)}</b> (~${fmtCups(batchTotalOz)})
      </div>

      <div class="divider"></div>
      <div class="muted"><b>Grocery breakdown</b> (batch totals)</div>
      <div class="savedBox">
        <div class="muted2 mono">${esc(groceryText)}</div>
      </div>

      <div class="divider"></div>
      <div class="muted"><b>Cooking instructions</b></div>
      <div class="savedBox">
        <div class="muted2 mono">${esc(instructions)}</div>
      </div>
    </div>
  `;
}

function buildGroceryText(d){
  const lines = [];
  lines.push(`BATCH GROCERY LIST ‚Äî ${d.days} day(s)`);
  lines.push(`Activity: ${activityLabel(d.activity)} (rule: ${fmtNumber(ACTIVITY_PCT[d.activity]||2.5,1)}% bodyweight/day)`);
  lines.push(`Meals/day: ${d.mealsPerDay}`);
  lines.push(``);
  lines.push(`MEAL PICKS`);
  lines.push(`- Protein: ${d.protein}`);
  lines.push(`- Carb: ${d.carb}`);
  lines.push(`- Veg: ${d.veggie}`);
  lines.push(`- Fat: ${d.fat}`);
  lines.push(`- Flavor: ${d.flavor1}${d.flavor2?` + ${d.flavor2}`:""}`);
  lines.push(``);
  lines.push(`TOTALS (lbs + oz)`);
  lines.push(`- ${d.protein}: ${fmtLbsOz(d.grams.protein)}`);
  lines.push(`- ${d.carb}: ${fmtLbsOz(d.grams.carb)}`);
  lines.push(`- ${d.veggie}: ${fmtLbsOz(d.grams.veg)}`);
  lines.push(`- ${d.fat}: ${fmtLbsOz(d.grams.fat)}`);
  lines.push(`- ${d.flavor1}: ${fmtLbsOz(d.boostA)} (‚âà ${fmtLiquidFromOz(d.boostA)})`);
  if(d.flavor2){
    lines.push(`- ${d.flavor2}: ${fmtLbsOz(d.boostB)} (‚âà ${fmtLiquidFromOz(d.boostB)})`);
  }
  lines.push(``);
  lines.push(`FEEDING AMOUNTS`);
  lines.push(`- Coco daily: ${fmtLbsOz(d.cocoDailyOz)} (~${fmtCups(d.cocoDailyOz)})`);
  lines.push(`- Coco per meal: ${fmtLbsOz(d.cocoPerMealOz)} (~${fmtCups(d.cocoPerMealOz)})`);
  lines.push(`- Ollie daily: ${fmtLbsOz(d.ollieDailyOz)} (~${fmtCups(d.ollieDailyOz)})`);
  lines.push(`- Ollie per meal: ${fmtLbsOz(d.olliePerMealOz)} (~${fmtCups(d.olliePerMealOz)})`);
  return lines.join("\n");
}

function buildCookingInstructions(d){
  const lines = [];
  lines.push(`COOKING INSTRUCTIONS (batch: ${d.days} day${d.days===1?"":"s"})`);
  lines.push(``);
  lines.push(`1) PROTEIN ‚Äî ${d.protein}`);
  lines.push(`   ‚Ä¢ Cook fully (no seasoning). Drain excess fat.`);
  lines.push(``);
  lines.push(`2) CARB ‚Äî ${d.carb}`);
  lines.push(`   ‚Ä¢ Cook separately in water. No salt, no onion/garlic.`);
  lines.push(``);
  lines.push(`3) VEG ‚Äî ${d.veggie}`);
  lines.push(`   ‚Ä¢ Steam lightly until soft. Avoid overcooking.`);
  lines.push(``);
  lines.push(`4) COMBINE`);
  lines.push(`   ‚Ä¢ Let everything cool. Then mix together.`);
  lines.push(`   ‚Ä¢ Add oils AFTER cooling (${d.fat}) so you don‚Äôt cook the nutrients off.`);
  lines.push(``);
  lines.push(`5) FLAVOR / MOISTURE`);
  lines.push(`   ‚Ä¢ Stir in: ${d.flavor1}${d.flavor2?` + ${d.flavor2}`:""}. Keep it plain.`);
  lines.push(``);
  lines.push(`6) STORE`);
  lines.push(`   ‚Ä¢ Portion daily containers. Refrigerate 3‚Äì4 days.`);
  lines.push(`   ‚Ä¢ Freeze anything beyond 3‚Äì4 days.`);
  return lines.join("\n");
}

function activityLabel(k){
  return ({
    sedentary:"Sedentary / weight loss",
    normal:"Normal",
    active:"Active",
    very_active:"Very active",
    working:"Working / high output"
  })[k] || k;
}

function copyLastGrocery(){
  if(!LAST_MEAL) return alert("Generate a meal first.");
  copyText(LAST_MEAL.groceryText);
}
function exportLastGrocery(){
  if(!LAST_MEAL) return alert("Generate a meal first.");
  downloadText(`grocery_${dateStamp()}.txt`, LAST_MEAL.groceryText);
}

/* =========================================================
   6) SAVE MEALS (snapshot) + render saved tab
   ========================================================= */

const LS_KEY = "cocoOllie_savedMeals_v1";

function saveMeal(){
  if(!LAST_MEAL){
    alert("Generate a meal first.");
    return;
  }
  const saved = loadSavedMeals();
  saved.unshift(LAST_MEAL); // newest first
  localStorage.setItem(LS_KEY, JSON.stringify(saved));
  renderSavedMeals();
  alert("Saved ‚úÖ");
}

function loadSavedMeals(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr;
  }catch(e){
    return [];
  }
}

function deleteMeal(id){
  const saved = loadSavedMeals().filter(m=>m.id !== id);
  localStorage.setItem(LS_KEY, JSON.stringify(saved));
  renderSavedMeals();
}

function renderSavedMeals(){
  const el = document.getElementById("savedMeals");
  const saved = loadSavedMeals();

  if(saved.length===0){
    el.innerHTML = `<div class="result"><div class="muted">No saved meals yet.</div></div>`;
    return;
  }

  let html = "";
  for(const m of saved){
    const when = new Date(m.createdAt).toLocaleString();
    const title = `${m.picks.protein} + ${m.picks.carb} + ${m.picks.veggie}`;
    const subtitle = `Batch: ${m.meta.days} day(s) ¬∑ Meals/day: ${m.meta.mealsPerDay} ¬∑ Activity: ${activityLabel(m.meta.activity)}`;

    html += `
      <div class="savedCard">
        <h3>üçΩÔ∏è ${esc(title)}</h3>
        <div class="savedMeta">${esc(when)} ¬∑ ${esc(subtitle)}</div>

        <div class="pillRow">
          <span class="pill good">Protein: ${esc(m.picks.protein)}</span>
          <span class="pill good">Carb: ${esc(m.picks.carb)}</span>
          <span class="pill good">Veg: ${esc(m.picks.veggie)}</span>
          <span class="pill good">Fat: ${esc(m.picks.fat)}</span>
          <span class="pill good">Flavor: ${esc(m.picks.flavor1)}${m.picks.flavor2?` + ${esc(m.picks.flavor2)}`:""}</span>
        </div>

        <div class="savedBox">
          <div class="muted"><b>Grocery</b></div>
          <div class="muted2 mono">${esc(m.groceryText)}</div>
          <div class="btnRow">
            <button class="btn" onclick="copyText(${jsonStr(m.groceryText)})">Copy Grocery</button>
            <button class="btn" onclick="downloadText('grocery_${dateStamp()}_${escJs(m.id)}.txt', ${jsonStr(m.groceryText)})">Export Grocery</button>
          </div>
        </div>

        <div class="savedBox">
          <div class="muted"><b>Cooking</b></div>
          <div class="muted2 mono">${esc(m.instructions)}</div>
          <div class="btnRow">
            <button class="btn" onclick="copyText(${jsonStr(m.instructions)})">Copy Instructions</button>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn danger" onclick="deleteMeal('${escJs(m.id)}')">Delete</button>
        </div>
      </div>
    `;
  }
  el.innerHTML = html;
}

/* =========================================================
   7) LISTS TAB rendering
   ========================================================= */

function renderLists(){
  const fC = `
<b>High:</b> ${DATA.food.coco.high.join(", ")}<br><br>
<b>Moderate:</b> ${DATA.food.coco.moderate.join(", ")}
  `;
  const fO = `
<b>High:</b> ${DATA.food.ollie.high.join(", ")}<br><br>
<b>Moderate:</b> ${DATA.food.ollie.moderate.join(", ")}
  `;
  const aC = `
<b>High:</b> ${DATA.additives.coco.high.join(", ")}<br><br>
<b>Moderate:</b> ${DATA.additives.coco.moderate.join(", ")}
  `;
  const aO = `
<b>High:</b> ${DATA.additives.ollie.high.join(", ")}<br><br>
<b>Moderate:</b> ${DATA.additives.ollie.moderate.join(", ")}
  `;

  const combinedFood = unique([
    ...DATA.food.coco.high, ...DATA.food.coco.moderate,
    ...DATA.food.ollie.high, ...DATA.food.ollie.moderate
  ]).sort((a,b)=>a.localeCompare(b));

  const combinedAdd = unique([
    ...DATA.additives.coco.high, ...DATA.additives.coco.moderate,
    ...DATA.additives.ollie.high, ...DATA.additives.ollie.moderate
  ]).sort((a,b)=>a.localeCompare(b));

  document.getElementById("listFoodCoco").innerHTML = fC;
  document.getElementById("listFoodOllie").innerHTML = fO;
  document.getElementById("listAddCoco").innerHTML = aC;
  document.getElementById("listAddOllie").innerHTML = aO;

  document.getElementById("listCombined").innerHTML = `
<b>Food (Combined):</b><br>${combinedFood.join(", ")}<br><br>
<b>Additives (Combined):</b><br>${combinedAdd.join(", ")}
  `;
}

/* =========================================================
   8) TAB switching + utilities
   ========================================================= */

function showTab(tab){
  const tabs = ["scanner","meal","saved","lists"];
  for(const t of tabs){
    document.getElementById(t).style.display = (t===tab) ? "block" : "none";
    document.getElementById("tab-"+t).classList.toggle("active", t===tab);
  }
  if(tab==="saved") renderSavedMeals();
  if(tab==="lists") renderLists();
}

function unique(arr){
  return [...new Set(arr)];
}

function esc(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function escJs(s){
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

function jsonStr(s){
  return JSON.stringify(String(s));
}

function copyText(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(String(text)).then(()=>alert("Copied ‚úÖ")).catch(()=>fallbackCopy(text));
  }else{
    fallbackCopy(text);
  }
}
function fallbackCopy(text){
  const ta = document.createElement("textarea");
  ta.value = String(text);
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);
  alert("Copied ‚úÖ");
}
function downloadText(filename, text){
  const blob = new Blob([String(text)], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function dateStamp(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}${m}${day}`;
}
function cryptoId(){
  // simple stable-ish id without requiring crypto API
  return "m_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

// Initial renders
renderSavedMeals();
</script>
</body>
</html>
